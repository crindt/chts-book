---
title: "Recreating 2001 Tables"
author: "Craig Rindt"
date: "09/30/2015"
output:
  pdf_document:
    keep_tex: yes
    toc: yes
  html_document:
    toc: yes
---

## Setup

```{r echo=FALSE}
if ( !exists("rd") ) { rd <- gsub("(.*?chts-book).*","\\1",getwd()) }
```

```{r recreating-2001-tables-setup,cache=FALSE,echo=TRUE}
# Set the working directory so we can access libraries
write(paste("Setting working directory to",rd,"\n"),stderr())
setwd(rd)

# Load common setup
suppressMessages(require(knitr))    # knitr creates documentation from this file
suppressMessages(require(pander))   # pander is a package for generating tables
suppressMessages(require(testit))   # testit is a testing library
suppressMessages(require(dplyr))
suppressMessages(library(logging))
suppressMessages(library(RCurl))
suppressMessages(library(jsonlite))
suppressMessages(library(lazyeval)) # for interp
library(chts2011)
library(chts2011pvt)
library(chts2011wgt)

# read in the FIPS county table for pretty printing
fipsctyca <- read.csv(paste(rd,"data/fips-county.csv",sep="/"),header=TRUE,
                       stringsAsFactors=FALSE) %>%
  filter(state=="CA") %>% 
  mutate(County=gsub(" County$","",county_name))


# set some knitr defaults for producing documentation outputs
opts_chunk$set(
  eval=TRUE,echo=TRUE,messages=FALSE,
  warnings=TRUE,errors=TRUE,cache=TRUE,dpi=300,
  size='tiny',collapse=TRUE,my.relfontsize=-1,
  fig.height=4)
options("scipen"=100,"digits"=4)          # default precision for floats
panderOptions('big.mark',',')             # use commas in big numbers
panderOptions('table.split.table',Inf)    # don't wrap tables
panderOptions('table.split.cells',Inf)    # don't wrap cells
panderOptions('keep.trailing.zeros',TRUE)
panderOptions('round',1)
```

```{r general-definitions}
single.family <- c(1)   # RESTY values: single family homes
multi.family  <- c(2:6) # RESTY values
```

## Weighting Calculations


Here we load in weights by region, weights by area, and weights by wd.

```{r load-weights}
library(chts2011wgt)
```


## Table A: KEY 2000-2001 TRAVEL SURVEY DATA FOR CALIFORNIA

Table A contains a range of information about households.  We describe how each is computed below.

Vehicles available is simply the weighted sum of the household vehicles available 
in the sample.

```{r table-a-1}
adat <- list()

# weighted sum of vehicles available
adat[['Vehicles Available']] <- sum(chts_hh$HHVEH*chts_hh$EXPHHWGT)
```

The next element is vehicles in use on the average weekday.  This requires 
weights based upon the subsample of households whose data 
was collected on a weekday.  **FIXME: Technically, this should omit holidays, which
is a step we leave for later improvement.**  We calculated this above.


```{r table-a-2}
# FIXME: wonder if the total vehicles (a-1) should be computed from the weekday set?
# in theory, it should be identical -->

# weighted sum of vehicles in use
# FIXME: original is by weekday
hhvehinuse <- chts_pla %>% filter(VEHNO > 0 & VEHNO < 9) %>% 
  left_join(chts_hh.wgt.wd,by=c('SAMPN')) %>%
  filter(WD==1) %>%   # select only weekdays
  group_by(SAMPN,VEHNO,NEXPHHWDWGT) %>% summarise(cnt=n())
hhvehinuselabel <- paste('Vehicles In Use on Average Weekday (',
            round(100*sum(hhvehinuse$NEXPHHWDWGT)/adat[['Vehicles Available']],2),
            '%)',sep="")
adat[[hhvehinuselabel]]  <- sum(hhvehinuse$NEXPHHWDWGT)
```

The total number of household workers is simply the weighted sum of the
`HHEMP` variable, which reports the number of full and/or part-time workers
in the household.

```{r table-a-3}
adat[['Full-Time/Part-Time Employees']] <-
  sum(chts_hh$HHEMP*chts_hh$EXPHHWGT)
```

Licensed drivers is computed similarly from the `HHLIC` variable.

```{r table-a-4}
adat[['Licensed Drivers']] <-
  sum(chts_hh$HHLIC*chts_hh$EXPHHWGT)
```

Occupied housing units is simply the sum of all households.

```{r table-a-5}
# Occupied Housing Units (Household) 11,502,866
tothh <- sum(chts_hh$EXPHHWGT)
adat[['Occupied Housing Units (Household)']] <- tothh
  
```

Following the definitions from 2001, we compute single housing units as the 
weighted sum of all households defined with `RESTY==1`, where `RESTY` is 
defined as follows:

```{r resty-list,echo=FALSE,results='asis'}
pandoc.list(strsplit((chts_md %>% filter(VAR.NAME=='RESTY'))[1,'VALUES'],'\n')[[1]])
```

```{r table-a-5-1}
# Single Housing Units 63.8%
adat[['Single Housing Units']] <- 
  round(100*sum((chts_hh%>%filter(RESTY %in% single.family))$EXPHHWGT)/tothh,1)
```

Multiple housing units is defined as duplexes, mobile homes, and multi-unit
buildings.

```{r table-a-5-2}
# Multiple Housing Units 35.6%
adat[['Multiple Housing Units']] <- 
  round(100*sum((chts_hh%>%filter(RESTY %in% multi.family))$EXPHHWGT)/tothh,1)
```

Other housing units are boats/RVs, other, or refused.

```{r table-a-5-3}
# Other Housing Units 0.6%
adat[['Other Housing Units']] <- 
  round(100*sum((chts_hh%>%filter(RESTY %in% c(7:99)))$EXPHHWGT)/tothh,1)
```

To compute the median household income when income is defined as ordinal variable, 
we'll follow the US Census bureau's method (described 
[here (p6)](http://www.census.gov/hhes/www/p60_243sa.pdf) and 
[here](http://www.s4.brown.edu/us2010/SUC/MHHINote.htm).  The method is 
to compute the median category and then use 
[pareto interpolation](https://en.wikipedia.org/wiki/Pareto_interpolation) 
within that category range to determine the median.  

```{r table-a-8}
# Median Household Income $47,865
suppressMessages(require(isotone)) # for weighted median function
median.category <- weighted.median(chts_hh$INCOM,chts_hh$EXPHHWGT)
# Get the upper and lower bound of this range
catvals <- assign_factors(c(median.category),'hh','INCOM')
# convert "$1,234 to $12,345" to c(1234,12345)
lohi <- as.integer(gsub("[$,]","",(unlist(strsplit(as.character(catvals[[1]])," to ")))))
# parameters for pareto interpolation
a <- lohi[1]  # income value at the lower limit of the category containing the median
b <- lohi[2]  # income value at the upper limit of the category containing the median
Pa <- (chts_hh %>% filter(INCOM < median.category) %>% 
         summarise(n=sum(EXPHHWGT)))[1,'n']/tothh
Pb <- (chts_hh %>% filter(INCOM < (median.category+1)) %>% 
         summarise(n=sum(EXPHHWGT)))[1,'n']/tothh
thetaf <- function(a,b,Pa,Pb) {
  return ((log10(1-Pa)-log10(1-Pb))/(log10(b)-log10(a)))
  }
kappaf <- function(a,b,Pa,Pb) {
  theta <- thetaf(a,b,Pa,Pb)
  return (((Pb-Pa)/((1/(a^theta)) - (1/(b^theta))))^(1/theta))
  }
theta <- thetaf(a,b,Pa,Pb)
kappa <- kappaf(a,b,Pa,Pb)
hhmedian <- kappa*(2^(1/theta))
adat[['Median Household Income']] <- hhmedian
```

To determine the persons per household, we compute the weighted mean of household size (`HHSIZ`)
using statewide expansion weights.

```{r table-a-9}
require(Hmisc)
# Persons Per Household 2.8
adat[['Persons per Household']] <-
  round(wtd.mean(chts_hh$HHSIZ,weights=chts_hh$EXPHHWGT),1)
```

We take a similar approach for vehicles per household, taking the weighted mean of the
`HHVEH` variable.

```{r table-a-10}
# Vehicles Per Household 1.9
adat[['Vehicles per Household']] <-
  round(wtd.mean(chts_hh$HHVEH,weights=chts_hh$EXPHHWGT),1)
```

For employees per household, we find the weighted mean of `HHEMP`.

```{r table-a-11}
# Full/Part-Time Employees Per Household 1.2
adat[['Full/Part-Time Employees Per Household']] <-
  round(wtd.mean(chts_hh$HHEMP,weights=chts_hh$EXPHHWGT),1)
```

And, finally, for licensed drivers per household, we compute the weighted mean of `HHLIC`.

```{r table-a-12}
# Licensed Drivers Per Household 1.7
# NOTE: persons 16 or older
adat[['Licensed Drivers Per Household']] <-
  round(wtd.mean(chts_hh$HHLIC,weights=chts_hh$EXPHHWGT),1)
```

Now, we can plot the table.

```{r table-a_1} 
res <- list()
res.a.1 <- t(t(unlist(adat)))
colnames(res.a.1) <- c("Household Information") 
res[['a.1.str']] <- pandoc.table.return(res.a.1,
             split.tables=Inf,split.cells=Inf, 
             justify=c('left','right'),
             big.mark=',',
             round=Inf,
             caption="TABLE A: Household Information")
```

```{r table-a_1-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['a.1.str']])
```

To determine household vehicle availability, we transform the `HHVEH` variable to be 0, 1, 2, and 3+

```{r table-a_2}
vd <- chts_hh %>% transmute(HHVEHg=ifelse(HHVEH>2,3,HHVEH),EXPHHWGT)
```

Then, we use the `wtd.table` function from the `Hmisc` package to generate a weighted frequency
table from that transformed data.

```{r table-a_2b,results='asis',cache=FALSE}
suppressMessages(require(Hmisc))
vd <- chts_hh %>% transmute(HHVEHg=ifelse(HHVEH>2,3,HHVEH),EXPHHWGT)
res.a.2 <- t(t(wtd.table(vd$HHVEHg,weights=vd$EXPHHWGT)$sum.of.weights))
res.a.2[,1] <- paste(round(100*res.a.2[,1]/sum(res.a.2[,1]),0),'%',sep='')
colnames(res.a.2) <- c('Household Vehicle Availability')
rownames(res.a.2) <- gsub("3 ","3+ ",paste(rownames(res.a.2),'Vehicles'))
res[['a.2.str']] <- pandoc.table.return(res.a.2,
             split.tables=Inf,split.cells=Inf, 
             justify=c('left','right'),
             big.mark=',',
             caption="TABLE A (cont): Household Vehicle Availability")
cat(res[['a.2.str']])
```

## Table B: Weekday Trip Information

The weekday trip information is based upon linked trips, which we can read in but we
need appropriate weights for weekday travel.  Recall that for Table A, we computed
household weights for weekdays.  Trips are person-specific, so we need to compute
*person* weights by weekday vs weekend.  Again, this requires recomputation of weights 
based upon the subsample of people whose data was collected on a weekday.  
**FIXME: Technically, this should omit holidays, which is a step we leave for later 
improvement.**

Now we have the necessary weights.  Let's read in the linked trips and join the
appropriate trips to people sampled on weekdays.

```{r setup-linked-trips}
ltf2 <- chts_lt %>% filter(!is.na(ltmode) & !is.na(oplano))
lt.wd <- chts_per.wgt.wd %>% filter(WD==1) %>% # grab weekday travelers
  select(SAMPN,PERNO,WD,NEXPPERWDWGT,NPERWDWGT) %>%  # select what we want
  left_join(ltf2,by=c('SAMPN','PERNO')) %>%  # join on the linked trips
  mutate(NEXPTCFPERWDWGT=NEXPPERWDWGT*ltTCF)  # compute the TCF weights
```

Now let's compute each element of the table.  Total trips will be the weighted
sum of the linked trips (including the GPS trip correction factor).  The first thing
we need to do is clarify some definitions.  We follow the definitions of the 2001 report:

```{r mode-defs-setup,echo=FALSE}

all.modes=sort(unique(ltf2$ltmode))

driver.trip.modes=c(5,8)

person.trip.modes=all.modes[-c(1,2,3,4)]

# only trips related to private vehicle occupancy
# see p298(312) of the 2001 summary report
vehicle.trip.modes <- c(5)  

public.transit.trip.modes <- 
  c(15,16,17,
    #18,  # don't include school bus?
    19,20,21,
    # 22,23, exclude Amtrak bus and other bus
    24,25,26,27,28
    )

public.transport.trip.modes <-
  c(public.transit.trip.modes,
    12, # greyhound == intercity bus?
    13,
    22,23 # include Amtrak bus and other bus as "intercity" bus
    )

mode.defs <- list(
  all.modes=all.modes,
  person.trip.modes=person.trip.modes,
  driver.trip.modes=driver.trip.modes,
  vehicle.trip.modes=vehicle.trip.modes,
  public.transit.trip.modes=public.transit.trip.modes,
  public.transport.trip.modes=public.transport.trip.modes
)


modetab <- data.frame(
  type=c("PERSON TRIPS",
          "DRIVER TRIPS",
          "PUBLIC TRANSIT TRIPS",
          "PUBLIC TRANSPORTATION TRIPS"),
  def2001=c("Include all in-vehicle driver and passenger trips including public transit and rail passengers for household members five years of age or older. Person trips exclude walk, bicycle, airplane (commercial and private), and \"other\" mode trips. Don’t Know and Refused responses are not included.",
             "Include automobile, pickup truck, RV, Sport Utility Vehicle, van, truck, and Motorcycle/Moped driver trips.",
             "Include modes such as local public bus, express bus, Dial-A-Ride/Paratransit, light rail/streetcar/trolley, Metro Blue Line, Metro Green Line, Metro Red Line, BART, CALTRAIN, Metro Link, and AMTRAK. (Note that intercity bus and commercial airplane passengers are not included as public transit trips in this report.)",
             "Include modes such as local public bus, express bus, Dial-A-Ride/Paratransit, light rail/streetcar/trolley, Metro Blue Line, Metro Green Line, Metro Red Line, BART, CALTRAIN, Metro Link, AMTRAK, intercity bus and commercial airplane passengers."),
  notes=c(
    "",
    "",
    "We have included school bus in this definition.  We interpreted intercity bus to be greyhound and Amtrak bus, so *excluded* here",
    "We interpreted intercity bus to be greyhound and Amtrak bus, so *included* here"
    ),
  modefilt=c(unlist(lapply(c(
    "ltmode %in% person.trip.modes",
    "ltmode %in% driver.trip.modes",
    "ltmode %in% public.transit.trip.modes",
    "ltmode %in% public.transport.trip.modes"
    ),function(f) { return (paste(interp(f,.values=mode.defs),sep="",collapse=""));}))),
  otherfilt=c(
    "AGE > 4",
    "","",""
    ),
  stringsAsFactors=FALSE)
res.b.0 <- modetab %>% transmute(
  type = type,
  "2001 Definition"=def2001,
  Modes=modefilt,                
  Notes=paste(notes,otherfilt,sep=". ")
  )
res.b.0$Modes <- lapply(res.b.0$Modes,function(f) { 
  return (
    paste(
      assign_factors(
        (data.frame(ltmode=all.modes) %>% filter_(f))$ltmode,
        'place','MODE',verbose=FALSE),
      sep="; ")) 
  })
b.0.str <- pandoc.table.return(
  res.b.0,
  style='multiline',
  split.tables=Inf,
  split.cells=Inf,
  justify=c('left','left','left','left')
  )
```

```{r results-b-0,results='asis',cache=FALSE,echo=FALSE}
cat(b.0.str)
```
    
              

```{r table-b-setup,echo=FALSE}
suppressMessages(require(lazyeval))
modetab <- modetab %>% mutate(
  filt=gsub(" & $","",paste(modefilt,otherfilt,sep=" & "))
  )
person.trips.filter <- interp(
  (modetab %>% filter(type=='PERSON TRIPS'))[1,'filt'],
  .values=mode.defs)
driver.trips.filter <- interp(
  (modetab %>% filter(type=='DRIVER TRIPS'))[1,'filt'],
  .values=mode.defs)
public.transit.trips.filter <- interp(
  (modetab %>% filter(type=='PUBLIC TRANSIT TRIPS'))[1,'filt'],
  .values=mode.defs)
public.transport.trips.filter <- interp(
  (modetab %>% filter(type=='PUBLIC TRANSPORT TRIPS'))[1,'filt'],
  .values=mode.defs)
```

```{r table-b-1}
# Total Trips 98,549,454
bdat=list()
bdat[['Total Trips']] <- 
  round(sum(lt.wd$NEXPTCFPERWDWGT,na.rm=TRUE),0)
```
```{r table-b-2}
# Person Trips* 91,011,903
# all trips except walk,bike,wheelchair, or non-motorized
lt.per.wd <- lt.wd %>% 
  left_join(chts_per %>% select(SAMPN,PERNO,AGE),by=c('SAMPN','PERNO')) %>%
  filter_(person.trips.filter)
bdat[['Person Trips*']] <- round(
  sum(
    lt.per.wd$NEXPTCFPERWDWGT,na.rm=TRUE
    ),
  0)
```
```{r table-b-3}
# Driver Trips** 68,053,113
# Vehicle driver or motorcycle driver
lt.driver.wd <- lt.wd %>% filter_(driver.trips.filter)
bdat[['Driver Trips**']] <- 
  round(
    sum(lt.driver.wd$NEXPTCFPERWDWGT,na.rm=TRUE),
    0)
```
```{r table-b-4}
# Total Trips Per Household 8.6
tot.hh.wd <- (chts_hh.wgt.wd %>% filter(WD==1) %>% summarise(n=sum(NEXPHHWDWGT)))[1,'n']
# FIXME Confirm hh totals align across weighting schemes
bdat[['Total Trips Per Household']] <-
  round(bdat[['Total Trips']]/tot.hh.wd,1)
# FIXME: Seems high?
```
```{r table-b-5}
# Person Trips Per Household 7.9
bdat[['Person Trips Per Household']] <-
  round(bdat[['Person Trips*']]/tot.hh.wd,1)
```
```{r table-b-6}
# Person Trips Per Person Five Years of Age or Older*** 3.0
tot.per.wd.5 <- 
  sum((chts_per %>% left_join(chts_per.wgt.wd,by=c('SAMPN','PERNO')) %>%
         #filter_(person.trips.filter) %>%
         filter(WD==1)
       )$NEXPPERWDWGT,na.rm=TRUE)
# FIXME: should match population marginal
bdat[['Person Trips Per Person Five Years of Age or Older***']] <-
  round(bdat[['Person Trips*']]/tot.per.wd.5,1)
```
```{r table-b-7}
# Driver Trips Per Household 5.9
bdat[['Driver Trips Per Household']] <-
  round(bdat[['Driver Trips**']]/tot.hh.wd,1)
```
```{r table-b-8}
# Driver Trips Per Vehicle Available 3.2
bdat[['Driver Trips Per Vehicle Available']] <-
  round(bdat[['Driver Trips**']]/adat[['Vehicles Available']],1)
```
```{r table-b-9}
# Driver Trips Per Vehicle In Use on Travel Day 4.8
bdat[['Driver Trips Per Vehicle In Use on Travel Day']] <-
  round(bdat[['Driver Trips**']]/adat[[hhvehinuselabel]],2)
```

Vehicle occupancy is a little tricky with linked trips as it varies per leg of trip.  
The linked trip table includes the maximum number of travelers on any leg (`MAXTR`)
and the minimum number of travelers (`MINTR`).  For our purposes here, we'll
assume we want the average *maximum* number of travelers.  However, there are many
records for which the number of travelers was not reported (these show up as `NA` records.
Necessarily, we need to compute the occupancy from the subset of linked trips without
`NA` values for `TOTTR`.

```{r table-b-10,cache=FALSE}
# Vehicle Occupancy
bdat[['Vehicle Occupancy']] <- 0
```
```{r table-b-10_1}
#  All Trips (24 hours) 1.4
lt.wd.trips<- lt.wd
lt.wd.trips.veh <- lt.wd.trips %>%
  # let's filter on only "vehicle" trips (no transit)
  filter(ltmode %in% vehicle.trip.modes)
bdat[['&nbsp;&nbsp;All Trips (24 hours)']] <-
  round(
    wtd.mean(lt.wd.trips.veh$MAXTR,
             weights=lt.wd.trips.veh$NEXPTCFPERWDWGT),
    1)
```

We interpret the 7-9am time window as a departure window.

```{r table-b-10_2}
#  All Trips (7-9 a.m.) 1.2
lt.wd.trips.am <- lt.wd.trips  %>% 
  # select all trips active during AM window
  filter((DEP_HR >= 7 & DEP_HR <9)) 

lt.wd.trips.am.veh <- lt.wd.trips.am %>% 
  # let's filter on only "vehicle" trips (no transit)
  filter(ltmode %in% vehicle.trip.modes)
bdat[['&nbsp;&nbsp;All Trips (7-9am)']] <-
  round(
    wtd.mean(    
      lt.wd.trips.am.veh$MAXTR,
      weights=lt.wd.trips.am.veh$NEXPTCFPERWDWGT),
    1)
```
```{r table-b-10_3}
#  Home-Work Trips (24 hours) 1.1
lt.wd.trips.hw.veh <- lt.wd.trips.veh %>% filter(TripType=='HW') 
lt.wd.trips.hw <- lt.wd.trips %>% filter(TripType=='HW') 
bdat[['&nbsp;&nbsp;Home-Work Trips (24 hours)']] <-
  round(
    wtd.mean(lt.wd.trips.hw.veh$MAXTR,
             weights=lt.wd.trips.hw.veh$NEXPTCFPERWDWGT),
    1)
```
```{r table-b-10_4}
#  Home-Work Trips (7-9 a.m.) 1.1
lt.wd.trips.am.hw.veh <- lt.wd.trips.am.veh %>% filter(TripType=='HW')  
bdat[['&nbsp;&nbsp;Home-Work Trips (7-9am)']] <-
  round(
    wtd.mean(lt.wd.trips.am.hw.veh$MAXTR,
             weights=lt.wd.trips.am.hw.veh$NEXPTCFPERWDWGT),
    1)
```
```{r table-b-11}
# Mean Travel Time (Respondent Reported)
bdat[['Mean Travel Time (Respondent Reported)']] <- 0 
```
```{r table-b-11_1}
#  Weekday 'All Trips' Trip Length 22 minutes
bdat[["&nbsp;&nbsp;Weekday 'All Trips' Trip Length"]] <- 
  round(
    wtd.mean(lt.wd.trips$tripdur, 
             weights=lt.wd.trips$NEXPTCFPERWDWGT),
    0)
```
```{r table-b-11_2,cache=FALSE}
#  Weekday 'Home-Work Trips' Trip Length 27 minutes
bdat[["&nbsp;&nbsp;Weekday 'Home-Work Trips' Trip Length"]] <-
  round(
    wtd.mean(lt.wd.trips.hw$tripdur, 
             weights=lt.wd.trips.hw$NEXPTCFPERWDWGT),
    0)
```

Now we can print the table.
```{r table-b-results-prep} 
res.b <- t(t(unlist(bdat)))  
colnames(res.b) <- c("Travel Data (Linked Trips)") 
res[['b.str']]<-pandoc.table.return(res.b,
             split.tables=Inf,split.cells=Inf, 
             justify=c('left','right'),
             big.mark=',',
             caption="TABLE B: Weekday Trip Information")
res[['b.str']] <- gsub("(\\*\\*\\s*)     0","\\1&nbsp;",res[['b.str']])
```

```{r table-b-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['b.str']])
```

## Table C - TRAVEL SURVEY DATA FOR CALIFORNIA---Travel Mode Distribution


```{r table-c}
lt.wd$modesummary <-
  factor(
    ifelse(
      lt.wd$ltmode %in% c(driver.trip.modes),
      1,
      ifelse(
        lt.wd$ltmode == 6,       # vehicle passenger trips
        2,
        ifelse(
          lt.wd$ltmode %in% c(public.transport.trip.modes),
          3,
          ifelse(
            lt.wd$ltmode==18,    # school bus trips
            4,
            ifelse(
              lt.wd$ltmode==2,   # bicycle trips
              5,
              ifelse(
                lt.wd$ltmode==1, # walk trips
                6,
                7)))))),
    levels=1:7,
    labels=c("Vehicle Driver Trips",
             "Vehicle Passenger Trips",
             "Public Transportation Trips",
             "School Bus Trips",
             "Bicycle Trips",
             "Walk Trips",
              "All Others")
    )
            
tot <- sum(lt.wd$NEXPTCFPERWDWGT,na.rm=TRUE)
res.c<-t(t(as.data.frame(
  wtd.table(lt.wd$modesummary,
                  weights=lt.wd$NEXPTCFPERWDWGT)$sum.of.weights/tot*100
  )))
colnames(res.c)<-c('Weekday.Percent')
res.c<-rbind(res.c,data.frame('Weekday.Percent'=c(sum(res.c[,'Weekday.Percent']))))
rownames(res.c)<-c(rownames(res.c)[1:7],'Total')
res[['c.str']]<-pandoc.table.return(res.c,
             split.tables=Inf,split.cells=Inf, 
             justify=c('left','right'),
             big.mark=',',
             round=1,
             caption="TABLE C: Weekday Mode Share Information")
```

```{r table-c-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['c.str']])
```

## Table D: TRAVEL SURVEY DATA FOR CALIFORNIA---Weekday Commute Mode Share Information

```{r table-d}
lt.wd.hw <- lt.wd %>% filter(TripType=='HW')

lt.wd.hw$modesummary <-
  factor(
    ifelse(
      lt.wd.hw$ltmode %in% c(driver.trip.modes) & lt.wd.hw$MAXTR==1,
      1,
      ifelse(
        lt.wd.hw$ltmode %in% c(6,7) | 
          # add in driver trips where MAXTR > 1
          (lt.wd.hw$ltmode %in% c(driver.trip.modes) & lt.wd.hw$MAXTR>1),
        2,
        ifelse(
          lt.wd.hw$ltmode %in% c(public.transit.trip.modes),
          3,
          ifelse(
            lt.wd.hw$ltmode==1,
            4,
            ifelse(lt.wd.hw$ltmode==2,
                   5,
                   6))))),
    levels=1:6,
    labels=c("Drove Alone",
             "Carpooled or Van Pooled",
             "Public Transit",
             "Walk",
             "Bicycle",
             "Others")
    )

            
tot <- sum(lt.wd.hw$NEXPTCFPERWDWGT,na.rm=TRUE)
tab<-t(t(as.data.frame(
    wtd.table(lt.wd.hw$modesummary,
              weights=lt.wd.hw$NEXPTCFPERWDWGT)$sum.of.weights/tot*100,
    )))
colnames(tab)<-'X.24.Hours'
tab<-rbind(tab,data.frame('X.24.Hours'=c(sum(tab[,'X.24.Hours']))))
colnames(tab)<-c('24 Hours')
rownames(tab)<-c(rownames(tab)[1:6],'Total')


lt.wd.hw.am <- lt.wd.hw  %>%                                          
    # select all trips active during AM window
  filter((DEP_HR >= 7 & DEP_HR <9)) 
tot2 <- sum(lt.wd.hw.am$NEXPTCFPERWDWGT,na.rm=TRUE)
tab2<-t(t(as.data.frame(
    wtd.table(lt.wd.hw.am$modesummary,
              weights=lt.wd.hw.am$NEXPTCFPERWDWGT)$sum.of.weights/tot2*100,
    )))
colnames(tab2)<-'AM'
tab2<-rbind(tab2,data.frame('AM'=c(sum(tab2[,'AM']))))
rownames(tab2)<-c(rownames(tab2)[1:6],'Total')

res.d <- cbind(tab,tab2 %>% select(AM))
res.d[['Commuter Mode Share---Weekday Trips']] <-
  rownames(res.d)
rownames(res.d)<-NULL
res.d <- res.d[,c(3,1,2)]

res[['d.str']] <- pandoc.table.return(res.d,
             split.tables=Inf,split.cells=Inf, 
             justify=c('left','right','right'),
             big.mark=',',
             round=1,
             caption="TABLE D: Weekday Mode Share Information",
             emphasize.strong.cols = 1) 
```

```{r table-d-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['d.str']])
```

## Table 1: PERSONS/VEHICLE PER HOUSEHOLD By County

```{r table-1}
# Statewide
hh <- chts_hh %>% mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
  left_join(fipsctyca,by=c('ICTFIP'='county_ansi')) %>%
  left_join(chts_hh.wgt.cty %>% select(-CTFIP),by=c("SAMPN"))
state<-hh %>% 
        summarise('phhw'=weighted.mean(HHSIZ,EXPHHWGT),
                  'vhhw'=weighted.mean(HHVEH,EXPHHWGT)
                  )
state$County <- 'California'

# By County
by.cty <-
      hh %>% group_by(County) %>% 
        summarise('phhw'=weighted.mean(HHSIZ,NEXPHHWGT),
                  'vhhw'=weighted.mean(HHVEH,NEXPHHWGT))

res.1 <- rbind(state,by.cty) %>% 
  select(County,'Persons per Household'=phhw,'Vehicles per Household'=vhhw) %>% 
  as.data.frame()

res[['1.str']] <- pandoc.table.return(
  res.1,
  justify=c('left','right','right'),
  emphasize.strong.rows=which(res.1$County=='California',arr.ind=TRUE),
  caption='TABLE 1: Persons/Vehicle per Household by County',
  big.mark=',',
  round=1
  )
```

```{r table-1-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['1.str']])
```

## TABLE 5: LICENSED DRIVERS PER HOUSEHOLD

Persons 16 years of age or older.

```{r table-5}
# Statewide
lic.ca <- chts_hh %>% summarise(
  County='California',  
  Licensed=round(wtd.mean(HHLIC,weights=EXPHHWGT),1)
  )

# Per County
lic.cty <-  chts_hh %>% 
  mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
  left_join(fipsctyca,by=c('ICTFIP'='county_ansi')) %>%
  left_join(chts_hh.wgt.cty %>% select(-CTFIP),by=c("SAMPN")) %>%
  group_by(County) %>%
  summarise(
    Licensed=wtd.mean(HHLIC,weights=NEXPHHWGT)
    )

res.5 <- rbind(lic.ca,lic.cty)

res[['5.str']] <- pandoc.table.return(
  res.5,
  justify=c('left','left'),
  caption="TABLE 5: Licensed Drivers Per Household by County",
  emphasize.strong.rows=which(res.5$County=='California',arr.ind=TRUE),
  big.mark = ',',
  round = 1
  )
```

```{r table-5-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['5.str']])
```

## TABLE 6: EMPLOYEES PER HOUSEHOLD

```{r table-6}
emp.ca <- chts_hh %>% summarise(
  County='California',
  Employed=round(wtd.mean(HHEMP,weights=EXPHHWGT),1)
  )
emp.reg <- chts_hh %>% 
  mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
  left_join(fipsctyca,by=c('ICTFIP'='county_ansi')) %>%
  left_join(chts_hh.wgt.cty %>% select(-CTFIP),by=c("SAMPN")) %>%
  group_by(County) %>%
  summarise(
    Employed=wtd.mean(HHEMP,weights=NEXPHHWGT)
    )

res.6 <- rbind(emp.ca,emp.reg)
res[['6.str']] <- pandoc.table.return(
  res.6,
  justify=c('left','left'),
  caption="TABLE 6: Employees per Household by County",
  emphasize.strong.rows=which(res.6$County=='California',arr.ind=TRUE),
  big.mark=',',
  round=1,
  keep.trailing.zeros = TRUE
  )
```

```{r table-6-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['6.str']])
```

## TABLE 9: WEEKDAY TRIP-TYPE DISTRIBUTION

```{r table-9-1}
suppressMessages(require(Hmisc))
dat<-(ltf2 %>% left_join(chts_per %>% select(SAMPN,PERNO,EXPPERWGT)) %>% 
             mutate(EXPTCFPERWGT=EXPPERWGT*ltTCF) %>%
        group_by(TripType) %>% filter(TripType!=""))
tt <- t(t(wtd.table(dat$TripType,weights=dat$EXPTCFPERWGT,type='table')))
ttt <- rownames(tt)
rownames(tt)<-NULL

res.9.1 <- data.frame(
  "Trip Type"=ttt,
  "Number"=tt,
  "Percent"=round(tt/sum(tt)*100,2))
res.9.1 <- rbind(res.9.1,
                data.frame(
                  `Trip Type`=c("TOTAL"),
                  "Number"=sum(res.9.1$Number),
                  "Percent"=sum(res.9.1$Percent)))
res[['9.str']] <- 
  pandoc.table.return(
    res.9.1,caption="TABLE 9: Weekday Trip Type Distribution",
    split.table=Inf,split.cells=Inf,
    justify=c('center','right','right'),
    style='multiline',
    emphasize.strong.rows=which(res.9.1$Trip.Type=='TOTAL',arr.ind=TRUE)
  )
```
```{r table-9-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['9.str']])
```


And here are the trip distribution tables by county.


```{r trip-dist-by-county}
data<-ltf2 %>% 
  filter(!is.na(dplano)) %>%
  left_join(chts_hh %>% mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
              left_join(fipsctyca,by=c('ICTFIP'='county_ansi')) %>% 
              select(SAMPN,County),by=c("SAMPN")) %>%
  left_join(chts_per.wgt.cty %>% select(SAMPN,PERNO,NEXPPERWGT)) %>%
  group_by(TripType) %>% filter(TripType!="")

res[['9.2.str']] <- 
  paste(
    lapply(
      c(sort(fipsctyca$County)),
      function(cty) {
        dat<-data %>% filter(County==cty)
        tt <- t(t(wtd.table(dat$TripType,weights=dat$NEXPPERWGT,type='table')))
        ttt <- rownames(tt)
        rownames(tt)<-NULL
        tabtot <- data.frame(
          "Trip Type"=ttt,
          "Number"=tt,
          "Percent"=round(tt/sum(tt)*100,2))
        tabtot <- rbind(tabtot,
                        data.frame(
                          "Trip Type"=c("TOTAL"),
                          "Number"=sum(tabtot$Number),
                          "Percent"=sum(tabtot$Percent)))
        return(
          pandoc.table.return(
            tabtot,
            caption=paste("TABLE 9 (cont): Weekday Trip Type Distribution (",cty,")",sep=""),
            split.table=Inf,split.cells=Inf,
            big.mark=',',
            round=1,
            justify=c('center','right','right'),
            style='multiline',
            emphasize.strong.rows=which(tabtot$Trip.Type=='TOTAL',arr.ind=TRUE))
        )
      }),
    collapse="\n\n")
```
```{r t9-2-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['9.2.str']])
```


## TABLE 10a: WEEKDAY PERSON TRIPS PER HOUSEHOLD

We're looking for weekday person trips per household broken down by county, housing unit type, vehicle ownership, and trip type.  We also want the total across all trip types for each category.
We're going to be working with the linked trip tables.

```{r table-10a-1}
# compute person trips per category
# Filter for weekday person trips and count the expanded total trips per type
data <- chts_lt %>% filter(!is.na(ltmode) & !is.na(oplano)) %>%
  filter(ltmode %in% person.trip.modes) %>%
  left_join(chts_per.wgt.wd,by=c('SAMPN','PERNO')) %>% # join statewide weekday weights (and WD)
  filter(WD==1) %>% # only weekdays
  left_join(chts_per.wgt.wd.cty,by=c('SAMPN','PERNO')) %>% # join county weekday weights
  group_by(SAMPN,PERNO,TripType) %>% 
  summarise(
    n.st=sum(NEXPPERWDWGT*ltTCF),
    n.cty=sum(NEXPPERWDCTYWGT*ltTCF)
    )

# next, attach the household characteristics to each trip observation
data2 <- data  %>% 
  left_join(chts_hh %>% mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
              left_join(fipsctyca,by=c('ICTFIP'='county_ansi')) %>% 
              select(SAMPN,RESTY,HHVEH,County) %>% 
              mutate(HHUT=ifelse(RESTY==1 | RESTY==2,'Single','Multiple'),
                     VOWN=ifelse(HHVEH<3,as.character(HHVEH),'3+')), 
            by=c('SAMPN'))

doagg <- function(dataa,aggv) {
  # Now, aggregate the expanded totals by the stratifications
  dots <- c(paste("sum(",aggv,",na.rm=TRUE)",sep=""))
  names <- c("n")
  aggp.all <- dataa %>% 
    group_by(County,HHUT,VOWN,TripType) %>% 
    summarise_(.dots=setNames(dots,names))
  aggp.hhut <- dataa %>% 
    mutate(VOWN='Subtotal') %>% 
    group_by(County,HHUT,VOWN,TripType) %>%
    summarise_(.dots=setNames(dots,names))
  aggp.tot <- dataa %>% 
    mutate(HHUT='Total',VOWN='&nbsp;') %>% 
    group_by(County,HHUT,VOWN,TripType ) %>%
    summarise_(.dots=setNames(dots,names))
  return(rbind(aggp.all,aggp.hhut,aggp.tot))
}
aggp <- rbind(doagg(data2,"n.cty"),
              doagg(data2 %>% mutate(County='California'),"n.st"))



# Now, we'll count the total households in each stratifications
hht <- chts_hh %>% mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
  left_join(fipsctyca,by=c('ICTFIP'='county_ansi')) %>% 
  select(SAMPN,RESTY,HHVEH,County) %>%
  left_join(chts_hh.wgt.wd,by=c('SAMPN')) %>%
  filter(WD==1) %>%
  left_join(chts_hh.wgt.wd.cty,by=c('SAMPN')) %>%
    mutate(HHUT=ifelse(RESTY==1 | RESTY==2,'Single','Multiple'),
           VOWN=ifelse(HHVEH<3,as.character(HHVEH),'3+'))

dohhagg <- function(dataa,sumarg) {
  dots <- c(paste("sum(",sumarg,",na.rm=TRUE)",sep=""))
  names <- c("hhn")

  datahh.all <- dataa %>%
    group_by(County,HHUT,VOWN) %>% 
    summarise_(.dots=setNames(dots,names))
  
  datahh.cty.hhut <- dataa %>% 
    mutate(VOWN='Subtotal') %>%
    group_by(County,HHUT,VOWN) %>% 
    summarise_(.dots=setNames(dots,names))
  
  datahh.cty <- dataa %>% 
    mutate(HHUT='Total',
           VOWN='&nbsp;') %>%
    group_by(County,HHUT,VOWN) %>% 
    summarise_(.dots=setNames(dots,names))
  return(rbind(datahh.all,datahh.cty.hhut,datahh.cty))
}
datahh <- rbind(
  dohhagg(hht,"NEXPHHWDCTYWGT"),
  dohhagg(hht %>% mutate(County='California'),"NEXPHHWDWGT")
)
  
```

Now, `data2` has the linked trips for each weekday person trip.  We can simply compute the mean for
each combination.

```{r table-10a-2}
# take the trip aggs (appg), join the household aggs by stratification, devide totals
agg1 <- aggp %>% left_join(datahh,by=c('County','HHUT','VOWN')) %>% 
  mutate(nn=n/hhn) %>% 
  select(-n,-hhn) %>% 
  ungroup()

# Sum the totals for each trip type
agg2 <- agg1 %>% group_by(County,HHUT,VOWN) %>% summarise(nn=sum(nn)) %>%
  mutate(TripType="zTOT")
library(tidyr)
res.10a <- rbind(agg1,agg2)  %>%
  arrange(County,HHUT,VOWN,TripType) %>%
  spread(TripType,nn) # reorganize for table

res[['10a.str']] = 
  paste(
    lapply(
      c('California',sort(fipsctyca$County)),
      function(cty) {
        dat<-res.10a %>% filter(County==cty) %>%
          mutate(County=ifelse(!is.na(lag(County)) & County==lag(County),"&nbsp;",County),
                 HHUT=ifelse(!is.na(lag(HHUT)) & HHUT==lag(HHUT),"&nbsp;",HHUT)
          ) %>%
          select(`Housing Unit Type`=HHUT,`Vehicle Ownership`=VOWN,HH,HO,HS,HW,OO,WO,WW,Total=zTOT)
        
        
        tab <- pandoc.table.return(
          dat,
          caption=paste("TABLE 10a: Weekday Person Trips Per Household (",cty,")",sep=""),
          split.table=Inf,
          split.cells=c(10,10,rep(5,8)),
          big.mark=',',
          round=1,
          justify=c(rep('center',2),rep('right',8)),
          style='multiline')
        
      }
    ),
    collapse = "\n\n"
  )
```

```{r t10a-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['10a.str']]) 
```


## TABLE 11: WEEKDAY DRIVER TRIPS PER HOUSEHOLD

Now we're looking for weekday person trips per household broken down by county, housing unit type, vehicle ownership, and trip type.  As with Table 10a, we also want the total across all trip types
for each category.


```{r table-11a-1}
# compute driver trips per category
# Filter for weekday driver trips and count the expanded total trips per type
data <- chts_lt %>% filter(!is.na(ltmode) & !is.na(oplano)) %>%
  filter(ltmode %in% driver.trip.modes) %>%
  left_join(chts_per.wgt.wd,by=c('SAMPN','PERNO')) %>% # join weekday weights (and WD)
  filter(WD==1) %>% # only weekdays
  left_join(chts_per.wgt.wd.cty,by=c('SAMPN','PERNO')) %>% # join weekday county weights
  group_by(SAMPN,PERNO,TripType) %>% 
  summarise(
    n.st=sum(NEXPPERWDWGT*ltTCF),
    n.cty=sum(NEXPPERWDCTYWGT*ltTCF) 
    )

# next, attach the household characteristics to each trip observation
data2 <- data  %>% 
  left_join(chts_hh %>% mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
              left_join(fipsctyca,by=c('ICTFIP'='county_ansi')) %>% 
              select(SAMPN,RESTY,HHVEH,County) %>% 
              mutate(HHUT=ifelse(RESTY==1 | RESTY==2,'Single','Multiple'),
                     VOWN=ifelse(HHVEH<3,as.character(HHVEH),'3+')), by=c('SAMPN'))

doagg <- function(dataa,aggf) {
  # Now, aggregate the expanded totals by the stratifications
  aggp.all <- dataa %>% 
    group_by(County,HHUT,VOWN,TripType) %>% 
    summarise_(.dots=setNames(list(aggf),c("n")))
  aggp.cty.hhut <- dataa %>% 
    mutate(VOWN='Subtotal') %>% 
    group_by(County,HHUT,VOWN,TripType) %>%
    summarise_(.dots=setNames(list(aggf),c("n")))
  aggp.cty <- dataa %>% 
    mutate(HHUT='Total',VOWN='&nbsp;') %>% 
    group_by(County,HHUT,VOWN,TripType ) %>%
    summarise_(.dots=setNames(list(aggf),c("n")))
  return(rbind(aggp.all,aggp.cty.hhut,aggp.cty))
}

aggp <- rbind(
  doagg(data2,~sum(n.cty,na.rm=TRUE)),
  doagg(data2 %>% mutate(County='California'),~sum(n.st,na.rm=TRUE))
)

dohhagg <- function(dataa,aggf) {

  # Now, we'll count the total households in each stratifications
  datahh.all <- dataa  %>%
    group_by(County,HHUT,VOWN) %>% 
    summarise_(.dots=setNames(list(aggf),c('hhn')))
  
  datahh.cty.hhut <- dataa %>% 
    mutate(VOWN='Subtotal') %>%
    group_by(County,HHUT,VOWN) %>% 
    summarise_(.dots=setNames(list(aggf),c('hhn')))
  
  datahh.cty <- dataa %>%  
    mutate(HHUT='Total',
           VOWN='&nbsp;') %>%
    group_by(County,HHUT,VOWN) %>% 
    summarise_(.dots=setNames(list(aggf),c('hhn')))

  return(rbind(rbind(datahh.all,datahh.cty.hhut,datahh.cty)))
}

hhdat <- chts_hh %>% mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
  left_join(fipsctyca,by=c('ICTFIP'='county_ansi')) %>% 
  select(SAMPN,RESTY,HHVEH,County) %>% 
  mutate(HHUT=ifelse(RESTY==1 | RESTY==2,'Single','Multiple'),
         VOWN=ifelse(HHVEH<3,as.character(HHVEH),'3+')) %>%
  left_join(chts_hh.wgt.wd,by=c('SAMPN'))  %>% 
  filter(WD==1) %>%
  left_join(chts_hh.wgt.wd.cty,by=c('SAMPN')) 

datahh <- rbind(
  dohhagg(hhdat,~sum(NEXPHHWDWGT,na.rm=TRUE)),
  dohhagg(hhdat %>% mutate(County='California'),~sum(NEXPHHWDCTYWGT,na.rm=TRUE))
)
```

Now, `data2` has the linked trips for each weekday person trip.  We can simply compute the mean for
each combination.

```{r table-11a-2}
# take the trip aggs (appg), join the household aggs by stratification, devide totals
agg1 <- aggp %>% left_join(datahh,by=c('County','HHUT','VOWN')) %>% 
  mutate(nn=n/hhn) %>% 
  select(-n,-hhn) %>% 
  ungroup()

# Sum the totals for each trip type
agg2 <- agg1 %>% group_by(County,HHUT,VOWN) %>% summarise(nn=sum(nn)) %>%
  mutate(TripType="zTOT")
library(tidyr)
res.11 <- rbind(agg1,agg2)  %>%
  arrange(County,HHUT,VOWN,TripType) %>%
  spread(TripType,nn) # reorganize for table

res[['11.str']] <-
  paste(
    lapply(
      c('California',sort(fipsctyca$County)),
      function(cty) {
        dat <- res.11 %>% filter(County==cty) %>%
          mutate(HHUT=ifelse(!is.na(lag(HHUT)) & HHUT==lag(HHUT),"&nbsp;",HHUT)
          ) %>%
          select(
            `Housing Unit Type`=HHUT,
            `Vehicle Ownership`=VOWN,
            HH,HO,HS,HW,OO,WO,WW,
            Total=zTOT)
        
        return(
          pandoc.table.return(
            dat,
            caption=paste("TABLE 11: Weekday Driver Trips Per Household (",cty,")",sep=""),
            split.table=Inf,
            split.cells=c(10,10,rep(5,8)),
            big.mark=',',
            round=1,
            justify=c(rep('center',2),rep('right',8)),
            style='multiline')
        )
      }  
    ),
    collapse="\n\n"
  )
```

```{r t11-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['11.str']]) 
```


## TABLE 13a: WEEKDAY PERSON AND DRIVER TRIPS PER HOUSEHOLD

```{r table13a}
# By County, HH
datapt <- chts_lt %>% filter(!is.na(ltmode) & !is.na(oplano)) %>%
  filter(ltmode %in% person.trip.modes) %>%
  left_join(chts_per.wgt.wd,by=c('SAMPN','PERNO')) %>% # join weekday weights (and WD)
  filter(WD==1) %>% # only weekdays
  left_join(chts_per.wgt.wd.cty,by=c('SAMPN','PERNO')) %>% # join weekday weights (and WD)
  group_by(SAMPN,PERNO) %>% 
  summarise(
    npt.st=sum(NEXPPERWDWGT*ltTCF),
    npt.cty=sum(NEXPPERWDCTYWGT*ltTCF)
    )

# next, attach the household characteristics to each trip observation
datapt2 <- datapt  %>% 
  left_join(chts_hh %>% mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
              left_join(fipsctyca,by=c('ICTFIP'='county_ansi')) %>% 
              select(SAMPN,RESTY,HHSIZ,County) %>% 
              mutate(HHUT=ifelse(RESTY==1 | RESTY==2,'Single','Multiple'),
                     HHSIZ=ifelse(HHSIZ<5,as.character(HHSIZ),'5+')), 
            by=c('SAMPN'))

datadt <- chts_lt %>% filter(!is.na(ltmode) & !is.na(oplano)) %>%
  filter(ltmode %in% driver.trip.modes) %>%
  left_join(chts_per.wgt.wd,by=c('SAMPN','PERNO')) %>% # join weekday weights (and WD)
  filter(WD==1) %>% # only weekdays
  left_join(chts_per.wgt.wd.cty,by=c('SAMPN','PERNO')) %>% # join weekday weights (and WD)
  group_by(SAMPN,PERNO) %>% 
  summarise(
    ndt.st=sum(NEXPPERWDWGT*ltTCF),
    ndt.cty=sum(NEXPPERWDCTYWGT*ltTCF)
    )

# next, attach the household characteristics to each trip observation
datadt2 <- datadt  %>% 
  left_join(chts_hh %>% mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
              left_join(fipsctyca,by=c('ICTFIP'='county_ansi')) %>% 
              select(SAMPN,RESTY,HHSIZ,County) %>% 
              mutate(HHUT=ifelse(RESTY==1 | RESTY==2,'Single','Multiple'),
                     HHSIZ=ifelse(HHSIZ<5,as.character(HHSIZ),'5+')), 
            by=c('SAMPN'))

data2 <- merge(datapt2,datadt2,all=TRUE)  # outer join

doagg <- function(dataa,aggf,aggn) {
  aggp.all <- dataa %>% 
    group_by(County,HHUT,HHSIZ) %>% 
    summarise_(.dots=setNames(aggf,aggn))
  
  aggp.cty.hhut <- dataa %>% 
    mutate(HHSIZ='Total') %>% 
    group_by(County,HHUT,HHSIZ) %>%
    summarise_(.dots=setNames(aggf,aggn))
  
  aggp.cty.hhsiz <- dataa %>% 
    mutate(HHUT='Total') %>% 
    group_by(County,HHUT,HHSIZ) %>%
    summarise_(.dots=setNames(aggf,aggn))
  
  aggp.cty <- dataa %>% 
    mutate(HHUT='Total',HHSIZ='Total') %>% 
    group_by(County,HHUT,HHSIZ) %>%
    summarise_(.dots=setNames(aggf,aggn))

  return(rbind(aggp.all,aggp.cty.hhut,aggp.cty.hhsiz,aggp.cty) %>% ungroup())
}

aggp <- rbind(
  doagg(data2,
        list(
          ~sum(npt.cty,na.rm=TRUE),
          ~sum(ndt.cty,na.rm=TRUE)
        ), c('npt','ndt')),
  doagg(data2 %>% mutate(County='California'),
        list(
          ~sum(npt.st,na.rm=TRUE),
          ~sum(ndt.st,na.rm=TRUE)
        ),c('npt','ndt'))
  )


hhdat <- chts_hh %>% 
  mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
  left_join(fipsctyca,by=c('ICTFIP'='county_ansi')) %>% 
  select(SAMPN,RESTY,HHSIZ,County) %>% 
  mutate(HHUT=ifelse(RESTY==1 | RESTY==2,'Single','Multiple'),
         HHSIZ=ifelse(HHSIZ<5,as.character(HHSIZ),'5+')) %>%
  left_join(chts_hh.wgt.wd,by=c('SAMPN'))  %>% 
  filter(WD==1) %>%
  left_join(chts_hh.wgt.wd.cty,by=c('SAMPN')) 

dohhagg <- function(dataa,aggf,aggn) {
  
  # Now, we'll count the total households in each stratifications
  datahh.all <- dataa %>%
    group_by(County,HHUT,HHSIZ) %>% 
    summarise_(.dots=setNames(aggf,aggn))
  
  datahh.cty.hhut <- dataa %>%  
    mutate(HHSIZ='Total') %>%
    group_by(County,HHUT,HHSIZ) %>% 
    summarise_(.dots=setNames(aggf,aggn))
  
  datahh.cty.hhsiz <- dataa %>%  
    mutate(HHUT='Total',
           HHSIZ=ifelse(HHSIZ<5,as.character(HHSIZ),'5+')) %>%
    group_by(County,HHUT,HHSIZ) %>% 
    summarise_(.dots=setNames(aggf,aggn))
  
  datahh.cty <- dataa %>%  
    mutate(HHUT='Total',
           HHSIZ='Total') %>%
    group_by(County,HHUT,HHSIZ) %>% 
    summarise_(.dots=setNames(aggf,aggn))
  
  return(rbind(datahh.all,datahh.cty.hhut,datahh.cty.hhsiz,datahh.cty))
}

datahh <- rbind(
  dohhagg(hhdat,list(~sum(NEXPHHWDCTYWGT)),c('hhn')),
  dohhagg(hhdat %>% mutate(County='California'),list(~sum(NEXPHHWDWGT)),c('hhn'))
)
```

```{r table-13a-2}
# take the trip aggs (appg), join the household aggs by stratification, devide totals
agg1 <- aggp %>% 
  left_join(datahh,by=c('County','HHUT','HHSIZ')) %>% 
  mutate(nnpt=npt/hhn,nndt=ndt/hhn) %>% 
  select(-npt,-ndt,-hhn) %>% ungroup()

library(tidyr)
res.13.a <- agg1  %>%
  arrange(County,HHUT,HHSIZ) %>% select(-nndt) %>%
  spread(HHUT,nnpt) %>% # reorganize for table
  select(County,HHSIZ,Single.nnpt=Single,Multiple.nnpt=Multiple,Total.nnpt=Total)
res.13.b <- agg1  %>%
  arrange(County,HHUT,HHSIZ) %>% select(-nnpt) %>%
  spread(HHUT,nndt) %>% # reorganize for table
  select(County,HHSIZ,Single.nndt=Single,Multiple.nndt=Multiple,Total.nndt=Total)
res.13 <- merge(res.13.a,res.13.b)
  
res[['13a.str']] = 
  paste(
    lapply(
      c('California',sort(fipsctyca$County)),
      function(cty) {
        dat<-res.13 %>% filter(County==cty) %>%
          select(`Household Size`=HHSIZ,
                 `Person-Trips per Household Single`=Single.nnpt,
                 `Person-Trips per Household Multiple`=Multiple.nnpt,
                 `Person-Trips per Household Total`=Total.nnpt,
                 `Driver-Trips per Household Single`=Single.nndt,
                 `Driver-Trips per Household Multiple`=Multiple.nndt,
                 `Driver-Trips per Household Total`=Total.nndt
          )
        
        return(pandoc.table.return(
          dat,
          caption=paste("TABLE 13: Weekday Person and Driver Trips Per Household (",cty,")",sep=""),
          split.table=Inf,
          split.cells=c(10,rep(6,6)),
          big.mark=',',
          round=1,
          #               justify=c('left','left','right','right','right'),
          style='multiline'))
      }),
    collapse="\n\n"
  )
```

```{r t13a-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['13a.str']])
```


## TABLE 15: WEEKDAY DRIVER TRIPS PER VEHICLE BY COUNTY, HH INCOME, AND HOUSING UNIT

```{r table-15}
# compute driver trips per category
# Filter for weekday driver trips and count the expanded total trips per type
data <- chts_lt %>% filter(!is.na(ltmode) & !is.na(oplano)) %>%
  filter(ltmode %in% driver.trip.modes) %>%
  left_join(chts_per.wgt.wd,by=c('SAMPN','PERNO')) %>% # join weekday weights (and WD)
  left_join(chts_per.wgt.wd.cty,by=c('SAMPN','PERNO')) %>% # join wd cty weights
  filter(WD==1) %>% # only weekdays
  group_by(SAMPN,PERNO) %>% 
  summarise(n.st=sum(NEXPPERWDWGT*ltTCF),
            n.cty=sum(NEXPPERWDWGT*ltTCF))

# next, attach the household characteristics to each trip observation
chts_hh_t <- chts_hh
chts_hh_t$INCOM <- assign_factors(chts_hh_t$INCOM,'hh','INCOM')

data2 <- data  %>% 
  left_join(chts_hh_t %>% mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
              left_join(fipsctyca,by=c('ICTFIP'='county_ansi')) %>% 
              select(SAMPN,RESTY,INCOM  ,County) %>% 
              mutate(HHUT=ifelse(RESTY==1 | RESTY==2,'Single','Multiple')), by=c('SAMPN'))

# Now, aggregate the expanded driver trip totals by the stratifications
doagg <- function(mydata) {
  ret <- function(cty) {
    mydat <- mydata
    if ( cty == 'California') mydat$County = cty
    mydat <- mydat %>% 
      filter(County==cty)
    
    aggp.cty.all <- mydat %>%
      group_by(County,HHUT,INCOM) %>% 
      summarise(n=sum(ifelse(grepl(paste("^",cty,"$",sep=""),County),n.cty,n.st),na.rm=TRUE))
    aggp.cty.hhut <- mydat %>% 
      mutate(INCOM='Total') %>%
      group_by(County,HHUT,INCOM) %>%
      summarise(n=sum(ifelse(grepl(paste("^",cty,"$",sep=""),County),n.cty,n.st),na.rm=TRUE))
    aggp.cty.incom <- mydat %>%
      mutate(HHUT='Total') %>%
      group_by(County,HHUT,INCOM) %>%
      summarise(n=sum(ifelse(grepl(paste("^",cty,"$",sep=""),County),n.cty,n.st),na.rm=TRUE))
    aggp.cty <- mydat %>%
      mutate(INCOM='Total',HHUT='Total') %>%
      group_by(County,HHUT,INCOM) %>%
      summarise(n=sum(ifelse(grepl(paste("^",cty,"$",sep=""),County),n.cty,n.st),na.rm=TRUE))

    
    return(rbind(aggp.cty.all,aggp.cty.hhut,aggp.cty.incom,aggp.cty))
  }
  return(ret)
}

aggp <- do.call(
  "rbind",
  lapply(
    c('California',sort(unique(fipsctyca$County))),
    doagg(data2)
  )
)

hhtt <- chts_hh_t %>% mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
  left_join(fipsctyca,by=c('ICTFIP'='county_ansi')) %>% 
  select(SAMPN,RESTY,INCOM,County,HHVEH) 

dohhagg <- function(mydata) {
  mydata2 <- mydata %>% 
    left_join(chts_hh.wgt.wd,by=c('SAMPN'))  %>% filter(WD==1) %>%
    left_join(chts_hh.wgt.wd.cty,by=c("SAMPN"))
  
  return(function(cty) {
    mydat <- mydata2
    if ( cty == 'California') mydat$County = cty
    mydat <- mydat %>% 
      filter(County==cty)
    
    # Now, we'll count the total expanded households in each stratifications
    datahh.cty.all <- mydat %>% 
      mutate(HHUT=ifelse(RESTY==1 | RESTY==2,'Single','Multiple')) %>%
      group_by(County,HHUT,INCOM) %>% 
      summarise(hhn=sum(ifelse(grepl(paste("^",cty,"$",sep=""),County),NEXPHHWDCTYWGT,NEXPHHWDWGT)*HHVEH))
    datahh.cty.hhut <- mydat %>% 
      mutate(HHUT=ifelse(RESTY==1 | RESTY==2,'Single','Multiple'),
             INCOM='Total'
      ) %>%
      group_by(County,HHUT,INCOM) %>% 
      summarise(hhn=sum(ifelse(grepl(paste("^",cty,"$",sep=""),County),NEXPHHWDCTYWGT,NEXPHHWDWGT)*HHVEH))
    datahh.cty.incom <- mydat %>% 
      mutate(HHUT='Total',
             INCOM=INCOM
      ) %>%
      group_by(County,HHUT,INCOM) %>% 
      summarise(hhn=sum(ifelse(grepl(paste("^",cty,"$",sep=""),County),NEXPHHWDCTYWGT,NEXPHHWDWGT)*HHVEH))
    datahh.cty <- mydat %>% 
      mutate(HHUT='Total',
             INCOM='Total'
      ) %>%
      group_by(County,HHUT,INCOM) %>% 
      summarise(hhn=sum(ifelse(grepl(paste("^",cty,"$",sep=""),County),NEXPHHWDCTYWGT,NEXPHHWDWGT)*HHVEH))
    
    return(rbind(datahh.cty.all,datahh.cty.hhut,datahh.cty.incom,datahh.cty))
  })
}


datahh <- do.call(
  "rbind",
  lapply(
    c('California',sort(unique(fipsctyca$County))),
    dohhagg(hhtt)
  )
)

  
```

Now, `data` has the linked trips for each weekday driver trip.  We can simply compute the mean for
each combination.

```{r table-15-3}
# take the trip aggs (appg), join the household aggs by stratification, devide totals
agg1 <- aggp %>% left_join(datahh,by=c('County','HHUT','INCOM')) %>% 
  mutate(nn=n/hhn) %>% select(-n,-hhn) %>% ungroup()

library(tidyr)
res.15 <- agg1  %>%
  spread(HHUT,nn) %>% # reorganize for table
  arrange(ifelse(County=='California','aaaaaaa',County),INCOM) %>% 
  select(County,INCOM,Single,Multiple,Total)

t <- lapply(
  c('California',sort(unique(res.15$County))),
  function(cty) {
    dat<-res.15 %>% filter(County==cty) %>%
      select(`Household Income`=INCOM,Single,Multiple,Total)
    
    return(pandoc.table.return(
      dat,
      caption=paste("TABLE 15: Weekday Driver Trips Per Vehicle (",cty,")",sep=""),
      split.table=Inf,split.cells=Inf,
      big.mark=',',
      round=1,
      #               justify=c('left','left','right','right','right'),
      style='multiline'))
  })
res[['15.str']] = paste(t,collapse="\n\n")

```


```{r table15-output,results='asis',cache=FALSE}
cat(res[['15.str']])
```



## TABLE 15a: WEEKDAY PERSON AND VEHICLE MILES TRAVELED PER VEHICLE BY COUNTY AND HH INCOME

```{r table-15a}
# compute person trips per category
# Filter for weekday person trips and count the expanded total trip distance per type
data <- chts_pla %>%
  left_join(chts_per.wgt.wd,by=c('SAMPN','PERNO')) %>% # join weekday weights (and WD)
  filter(WD==1 & !is.na(TCF) & !is.na(TripDistance)) %>% # only weekdays
  group_by(SAMPN,PERNO) %>% summarise(
    n=sum(NEXPPERWDWGT*TCF*TripDistance),
    nv=sum(ifelse(MODE %in% driver.trip.modes,NEXPPERWDWGT*TCF*TripDistance,0))
    )

# next, attach the household characteristics to each trip observation
hhtt <- chts_hh %>% mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
  left_join(fipsctyca,by=c('ICTFIP'='county_ansi')) %>% 
  select(SAMPN,INCOM,County)
hhtt$INCOM <- assign_factors(hhtt$INCOM,'hh','INCOM')

data2 <- data  %>% 
  left_join(hhtt, by=c('SAMPN'))

# Now, aggregate the expanded driver trip totals by the stratifications
aggp.all <- data2 %>% group_by(County,INCOM) %>% summarise(n=sum(n),nv=sum(nv))
aggp.cty <- data2 %>% 
  mutate(INCOM='Total') %>% 
  group_by(County,INCOM) %>% 
  summarise(n=sum(n),nv=sum(nv))
aggp <- rbind(aggp.all,aggp.cty)

# Now, we'll count the total expanded households in each stratifications
datahh.all <- hhtt %>% 
  left_join(chts_hh.wgt.wd,by=c('SAMPN'))  %>% filter(WD==1) %>%
  group_by(County,INCOM) %>% summarise(hhn=sum(NEXPHHWDWGT))
datahh.cty <- datahh.all %>% ungroup() %>% 
  mutate(INCOM='Total') %>%
  group_by(County,INCOM) %>% summarise(hhn=sum(hhn))
datahh <- rbind(datahh.all,datahh.cty)
```

Now, `data` has the linked trips for each weekday driver trip.  We can simply compute the mean for
each combination.

```{r table-15a-3}
# take the trip aggs (appg), join the household aggs by stratification, devide totals
res.15a <- aggp %>% 
  left_join(datahh,by=c('County','INCOM')) %>% 
  mutate(nn=n/hhn,nnv=nv/hhn) %>% 
  select(-n,-nv,-hhn) %>% ungroup()

res[['15a.str']] = ''
for (var in sort(unique(res.15a$County))) {
  dat<-res.15a %>% filter(County==var) %>%
    select(`Household Income`=INCOM,`PMT/HH`=nn,`VMT/HH`=nnv)

  tab <- pandoc.table.return(
    dat,
    caption=paste("TABLE 15a: Person and Vehicle Miles Traveled per Household (",var,")",sep=""),
    split.table=Inf,split.cells=Inf,
    big.mark=',',
    round=1,
    justify=c('center','right','right'),
    style='multiline')
  res[['15a.str']] <- paste(res[['15a.str']],tab,sep="\n\n")
}
```


```{r table15a-output,results='asis',cache=FALSE}
cat(res[['15a.str']])
```


## TABLE 17a: WEEKDAY UNLINKED AND LINKED TRIPS DISTRIBUTED BY PARTICULAR TRAVEL MODE AND GROUP

```{r table-17a}
mode.groups <- data.frame( 
  ltmode=c(
    c(5,8,10),
    c(6,7,9,11,14),
    c(15,16,17,18,19,20,21,22,23,24,25,26,27),
    c(12,13),
    c(1,2,3,4,28,29)
    ),
  MODE.GROUP=c(
    rep('Vehicle Driver',3),
    rep('Vehicle Passenger',5),
    rep('Local Public Transit',13),
    rep('Intercity Public Transportation',2),
    rep('Miscelleneous Modes',6)
    ),
  stringsAsFactors=FALSE
  )

# unlinked trips
tab.ul <- chts_pla %>% 
  left_join(chts_per.wgt.wd,by=c('SAMPN','PERNO')) %>%
  filter(WD==1) %>%
  filter(!is.na(MODE)) %>%
  left_join(mode.groups %>% select(MODE.GROUP=MODE.GROUP,MODE=ltmode)) %>% 
  mutate(NEXPTCFPERWDWGT=NEXPPERWDWGT*TCF) %>%
  group_by(MODE.GROUP,MODE) %>% 
  summarise(num=sum(NEXPTCFPERWDWGT,na.rm=TRUE))
tab.ul$MODE <- assign_factors(tab.ul$MODE,'place','MODE',maxlab=20)
tots.ul <- tab.ul %>% ungroup() %>% group_by(MODE.GROUP) %>% summarise(MODE="TOTAL",tnum=sum(num))
gtots.ul <-  tots.ul %>% filter(MODE=='TOTAL') %>% 
  summarise(MODE.GROUP='ALL GROUPS',
            MODE='TOTAL',
            gtnum=sum(tnum))
ftab.ul <- rbind(tab.ul,tots.ul %>% select(MODE.GROUP,MODE,num=tnum)) %>% 
  arrange(MODE.GROUP,num) %>%
  left_join(tots.ul %>% select(-MODE),by=c('MODE.GROUP')) %>%
  rbind(gtots.ul %>% transmute(MODE.GROUP=MODE.GROUP,MODE=MODE,num=gtnum,tnum=gtnum))

fftab.ul <- ftab.ul %>%
  ungroup() %>%
  transmute(
    MODE.GROUP=MODE.GROUP,
    MODE=as.character(MODE),
    `Number of Unlinked Trips`=round(num,0),
    `Percent of Total Unlinked`=round(num/gtots.ul$gtnum[1]*100,1),
    SORT.ORDER=ifelse(MODE.GROUP=='ALL GROUPS',
                      -Inf,
                      ifelse(MODE.GROUP=='Miscelleneous Modes',
                             -(tnum*100000000-ifelse(MODE=='TOTAL',-num,num)),
                             tnum*100000000+ifelse(MODE=='TOTAL',-num,num)))
    )

# linked trips
tab <- lt.wd %>% 
  left_join(mode.groups) %>% group_by(MODE.GROUP,ltmode) %>% 
  filter(!is.na(ltmode)) %>%
  summarise(num=sum(NEXPTCFPERWDWGT,na.rm=TRUE))
#  summarise(num=n())
tab$ltmode <- assign_factors(tab$ltmode,'place','MODE',maxlab = 20)
tots <- tab %>% ungroup() %>% group_by(MODE.GROUP) %>% summarise(ltmode="TOTAL",tnum=sum(num))
gtots <-  tots %>% filter(ltmode=='TOTAL') %>% 
  summarise(MODE.GROUP='ALL GROUPS',
            ltmode='TOTAL',
            gtnum=sum(tnum))
ftab <- rbind(tab,tots %>% select(MODE.GROUP,ltmode,num=tnum)) %>% arrange(MODE.GROUP,num) %>%
  left_join(tots %>% select(-ltmode),by=c('MODE.GROUP')) %>%
  rbind(gtots %>% transmute(MODE.GROUP=MODE.GROUP,ltmode=ltmode,num=gtnum,tnum=gtnum))


fftab <- ftab %>%
  ungroup() %>%
  transmute(
    MODE.GROUP=MODE.GROUP,
    MODE=as.character(ltmode),
    `Number of Linked Trips`=round(num,0),
    `Percent of Total Linked`=round(num/gtots$gtnum[1]*100,1))
 
fftab.all <- fftab.ul %>% left_join(fftab,by=c('MODE.GROUP','MODE')) %>%
  transmute(
    `TRAVEL MODE GROUP`=MODE.GROUP,
    MODE=MODE,
    `Number of Unlinked Trips`=`Number of Unlinked Trips`,
    `Percent of Total Unlinked`=`Percent of Total Unlinked`,
    `Number of Linked Trips`=`Number of Linked Trips`,
    `Percent of Total Linked`=`Percent of Total Linked`,
    SORT.ORDER=SORT.ORDER
    ) %>%
  arrange(desc(SORT.ORDER)) %>%
  mutate(`TRAVEL MODE GROUP`=ifelse(is.na(lag(MODE)) | grepl('TOTAL',lag(MODE)), 
                                    `TRAVEL MODE GROUP`, "&nbsp;")) %>%
  select(-SORT.ORDER)


res.17a <- fftab.all

res[['17a.str']] <- pandoc.table.return(res.17a,
             caption=paste("TABLE 17a: Weekday Linked and Unlinked Trips Distributed by Particular Travel Mode and Group (California)",sep=""),
             split.table=Inf,split.cells=Inf,
             justify=c('left','left','right','right','right','right'),
             style='multiline',
             round=Inf
             #,emphasize.strong.rows=which(fftab.all$MODE=='TOTAL',arr.ind=TRUE)
             )
```
```{r table-17a-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['17a.str']])
```

Now, by county.

```{r table-17a-2}
mode.groups <- data.frame( 
  ltmode=c(
    c(5,8,10),
    c(6,7,9,11,14),
    c(15,16,17,18,19,20,21,22,23,24,25,26,27),
    c(12,13),
    c(1,2,3,4,28,29)
    ),
  MODE.GROUP=c(
    rep('Vehicle Driver',3),
    rep('Vehicle Passenger',5),
    rep('Local Public Transit',13),
    rep('Intercity Public Transportation',2),
    rep('Miscelleneous Modes',6)
    ),
  stringsAsFactors=FALSE
  )

lt.wd.cty <- chts_per.wgt.wd.cty %>% 
  filter(grepl("\\.1$",GROUP)) %>% # grab weekday travelers
  select(SAMPN,PERNO,GROUP,NEXPPERWDCTYWGT,NPERWDCTYWGT) %>%  # select what we want
  left_join(chts_lt,by=c('SAMPN','PERNO')) %>%  # join on the linked trips
  mutate(NEXPTCFPERWDCTYWGT=NEXPPERWDCTYWGT*ltTCF)  # compute the TCF weights

tab.ul.raw <-chts_pla %>% 
    arrange(SAMPN,PERNO,PLANO) %>%
    mutate(oCTFIP=lag(CTFIP)) %>%
    left_join(chts_per.wgt.wd.cty,by=c('SAMPN','PERNO')) %>%
    filter(!is.na(MODE))
  
tab.raw <- lt.wd.cty %>% 
    filter(!is.na(ltmode)) %>%
    left_join(mode.groups) %>% group_by(MODE.GROUP,ltmode) %>% 
    left_join(chts_pla %>% select(SAMPN,PERNO,PLANO,oCTFIP=CTFIP),
              by=c("SAMPN"="SAMPN","PERNO"="PERNO",
                   "oplano"="PLANO")) %>%
    left_join(chts_pla %>% select(SAMPN,PERNO,PLANO,dCTFIP=CTFIP),
              by=c("SAMPN"="SAMPN","PERNO"="PERNO",
                   "dplano"="PLANO"))

t <- lapply(
  sort(unique(fipsctyca$county_ansi)),
  function(ctyi) {
  cty <- sprintf("%3.3d",ctyi)
  # unlinked trips

  tab.ul <- 
    tab.ul.raw %>%
    filter(grepl("\\.1$",GROUP) & (CTFIP==cty | oCTFIP==cty)) %>%
    left_join(mode.groups %>% select(MODE.GROUP=MODE.GROUP,MODE=ltmode)) %>% 
    mutate(NEXPTCFPERWDCTYWGT=NEXPPERWDCTYWGT*TCF) %>%
    group_by(MODE.GROUP,MODE) %>% 
    summarise(num=sum(NEXPTCFPERWDCTYWGT,na.rm=TRUE))
  tab.ul$MODE <- assign_factors(tab.ul$MODE,'place','MODE',maxlab=20)
  tots.ul <- tab.ul %>% ungroup() %>% group_by(MODE.GROUP) %>% summarise(MODE="TOTAL",tnum=sum(num))
  gtots.ul <-  tots.ul %>% filter(MODE=='TOTAL') %>% 
    summarise(MODE.GROUP='ALL GROUPS',
              MODE='TOTAL',
              gtnum=sum(tnum))
  ftab.ul <- rbind(tab.ul,tots.ul %>% select(MODE.GROUP,MODE,num=tnum)) %>% 
    arrange(MODE.GROUP,num) %>%
    left_join(tots.ul %>% select(-MODE),by=c('MODE.GROUP')) %>%
    rbind(gtots.ul %>% transmute(MODE.GROUP=MODE.GROUP,MODE=MODE,num=gtnum,tnum=gtnum))
  
  fftab.ul <- ftab.ul %>%
    ungroup() %>%
    transmute(
      MODE.GROUP=MODE.GROUP,
      MODE=as.character(MODE),
      `Number of Unlinked Trips`=num,
      `Percent of Total Unlinked`=round(num/gtots.ul$gtnum[1]*100,1),
      SORT.ORDER=ifelse(MODE.GROUP=='ALL GROUPS',
                        -Inf,
                        ifelse(MODE.GROUP=='Miscelleneous Modes',
                               -(tnum*100000000-ifelse(MODE=='TOTAL',-num,num)),
                               tnum*100000000+ifelse(MODE=='TOTAL',-num,num)))
      )
  
  # linked trips
  tab <- 
    tab.raw %>%
    filter(oCTFIP==cty | dCTFIP==cty) %>%
    summarise(num=sum(NEXPTCFPERWDCTYWGT,na.rm=TRUE))
  #  summarise(num=n())
  tab$ltmode <- assign_factors(tab$ltmode,'place','MODE',maxlab = 20)
  tots <- tab %>% ungroup() %>% group_by(MODE.GROUP) %>% summarise(ltmode="TOTAL",tnum=sum(num))
  gtots <-  tots %>% filter(ltmode=='TOTAL') %>% 
    summarise(MODE.GROUP='ALL GROUPS',
              ltmode='TOTAL',
              gtnum=sum(tnum))
  ftab <- rbind(tab,tots %>% select(MODE.GROUP,ltmode,num=tnum)) %>% arrange(MODE.GROUP,num) %>%
    left_join(tots %>% select(-ltmode),by=c('MODE.GROUP')) %>%
    rbind(gtots %>% transmute(MODE.GROUP=MODE.GROUP,ltmode=ltmode,num=gtnum,tnum=gtnum))
  
  
  fftab <- ftab %>%
    ungroup() %>%
    transmute(
      MODE.GROUP=MODE.GROUP,
      MODE=as.character(ltmode),
      `Number of Linked Trips`=round(num,0),
      `Percent of Total Linked`=round(num/gtots$gtnum[1]*100,1))
  
  fftab.all <- fftab.ul %>% left_join(fftab,by=c('MODE.GROUP','MODE')) %>%
    transmute(
      `TRAVEL MODE GROUP`=MODE.GROUP,
      MODE=MODE,
      `Number of Unlinked Trips`=`Number of Unlinked Trips`,
      `Percent of Total Unlinked`=`Percent of Total Unlinked`,
      `Number of Linked Trips`=`Number of Linked Trips`,
      `Percent of Total Linked`=`Percent of Total Linked`,
      SORT.ORDER=SORT.ORDER
      ) %>%
    arrange(desc(SORT.ORDER)) %>%
    mutate(`TRAVEL MODE GROUP`=ifelse(is.na(lag(MODE)) | grepl('TOTAL',lag(MODE)), 
                                      `TRAVEL MODE GROUP`, "&nbsp;")) %>%
    select(-SORT.ORDER)
  
  cty.name <- (fipsctyca %>% filter(county_ansi==as.integer(cty)))$county_name
  
  return(
    pandoc.table.return(fftab.all,
                        caption=paste("TABLE 17a (cont): Weekday Linked and Unlinked Trips Distributed by Particular Travel Mode and Group (",cty.name,")",sep=""),
                        split.table=Inf,split.cells=Inf,
                        justify=c('left','left','right','right','right','right'),
                        style='multiline',
                        round=Inf
                        #,emphasize.strong.rows=which(fftab.all$MODE=='TOTAL',arr.ind=TRUE
    )
  )
  })
res[['17a.cty.str']] <- paste(t,collapse="\n\n")
```

```{r t17a-cty-results,echo=FALSE,results='asis',cache=FALSE}
cat(res[['17a.cty.str']])
```

## Table 17B and 17C: Weekday Commuters' Directional Travel Mode Split. All Home-to-Work trips and 7:00-9:00am Home-to-Work trips

```{r table-17bc}
mode.groups <- data.frame( 
  ltmode=c(
    c(5,8,10),
    c(6,7,9,11,14),
    c(15,16,17,18,19,20,21,22,23,24,25,26,27),
    c(12,13),
    c(1),
    c(2),
    c(3,4,28,29)
    ),
  MODE.GROUP=c(
    rep('Vehicle Driver',3),
    rep('Vehicle Passenger',5),
    rep('Local Public Transit',13),
    rep('Intercity Public Transportation',2),
    rep('Walk',1),
    rep('Bike',1),
    rep('Miscelleneous Modes',4)
    ),
  order = c(
    rep(1,3),
    rep(2,5),
    rep(3,13),
    rep(4,2),
    rep(5,1),
    rep(6,1),
    rep(7,4)
  ),
  stringsAsFactors=FALSE
  )

gentab <- function(data) {
  tab <- data %>%  
    left_join(mode.groups,by=c('ltmode')) %>% group_by(MODE.GROUP,ltmode) %>% 
    summarise(num=sum(NEXPTCFPERWDWGT,na.rm=TRUE),order=min(order)) %>% 
    ungroup() %>%
    arrange(order,MODE.GROUP)
  
  tots <- tab %>% ungroup() %>% group_by(MODE.GROUP) %>% 
    summarise(tnum=sum(num),order=min(order)) %>% ungroup() %>%
    arrange(order,MODE.GROUP)
  gtots <-  tots %>%  
    summarise(MODE.GROUP='Total',
              gtnum=sum(tnum),order=Inf)
  ftab <- tots %>% select(MODE.GROUP,num=tnum,order) %>%
    rbind(gtots %>% transmute(MODE.GROUP=MODE.GROUP,num=gtnum,order=order))
  ftab <- ftab %>% ungroup() %>%
    mutate(pct = round(num/gtots$gtnum[1]*100,1))
  return(ftab)
}

# linked trips
All.lt <- lt.wd %>%
  filter(!is.na(ltmode) & TripType=='HW') %>%
  left_join(chts_hh %>% mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
              left_join(fipsctyca,by=c('ICTFIP'='county_ansi')), 
            by=c('SAMPN'))


Am.lt <- All.lt %>% filter(DEP_HR %in% c(7,8))

t <- lapply(
  c("California",sort(unique(All.lt$County))),
  function(cty) {
  
  all.lt <- All.lt
  am.lt <- Am.lt
  if(cty != "California") {
    all.lt <- All.lt %>% filter(County==cty)
    am.lt  <- Am.lt %>% filter(County==cty)
  }
  
  fftab.alldayt <- gentab(all.lt) %>% mutate(period='All.Day')
  fftab.allday <- fftab.alldayt %>% 
    select(MODE.GROUP,order,num,period) %>% 
    spread(period,num) %>% 
    select(MODE.GROUP,All.Day.num=All.Day,order) %>% 
    left_join(fftab.alldayt %>% 
                select(MODE.GROUP,pct,period) %>% 
                spread(period,pct) %>% 
                select(MODE.GROUP,All.Day.pct=All.Day),
              by=c('MODE.GROUP')) %>% 
    arrange(order) 
  
  fftab.amt <- gentab(am.lt) %>% mutate(period='AM')
  fftab.am <- fftab.amt %>% 
    select(MODE.GROUP,order,num,period) %>% 
    spread(period,num) %>% 
    select(MODE.GROUP,AM.num=AM,order) %>% 
    left_join(fftab.amt %>% 
                select(MODE.GROUP,pct,period) %>% 
                spread(period,pct) %>% 
                select(MODE.GROUP,AM.pct=AM),
              by=c('MODE.GROUP')) %>% 
    arrange(order) %>% select(-order) 
  
  fftab.all <- merge(fftab.allday,fftab.am,by=c('MODE.GROUP')) %>%
    arrange(order) %>%
    select(`Travel Mode`=MODE.GROUP,
           `All Home-to-Work Trips`=All.Day.num,
           `All Home-to-Work Trips (%)`=All.Day.pct,
           `7:00-9:00am Home-to-Work Commute Trips`=AM.num,
           `7:00-9:00am Home-to-Work Commute Trips (%)`=AM.pct,
           order=order
    ) %>%
    mutate(County=cty)
  if ( !exists("res.17bc") ) {
    res.17bc = fftab.all
  } else {
    res.17bc <- rbind(res.17bc,fftab.all)
  }
  
  return(
    pandoc.table.return(
      fftab.all %>% arrange(order) %>% select(-order,-County),
      caption=paste("TABLES 17b and 17c: Weekday Commuters' Directional Travel Mode by County (",cty,")",sep=""),
      split.table=Inf,split.cells=Inf,
      justify=c('left','right','right','right','right'),
      style='multiline',
      round=Inf
      #,emphasize.strong.rows=which(fftab.all$MODE=='TOTAL',arr.ind=TRUE
    )
  )
  })
res[['17bc.str']] <- paste(t,collapse="\n\n")
```
```{r table-17bc-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['17bc.str']])
```

## TABLE 22: Age of Vehicle in Use on Travel Day by County and Vehicle Type

```{r table-22}
Vehdat <- chts_veh %>%
  left_join(chts_hh %>% mutate(ICTFIP=as.integer(CTFIP)%%1000) %>%
              select(-HHWGT,-EXPHHWGT) %>%
              left_join(fipsctyca,by=c('ICTFIP'='county_ansi')), 
            by=c('SAMPN')) %>%
  left_join(chts_hh.wgt.wd.cty,by=c("SAMPN")) %>%
  left_join(chts_hh.wgt.wd,by=c("SAMPN")) %>%
  mutate(WD=ifelse(DOW<6,1,2)) %>%
  filter(WD==1)

t <- lapply(
      c("California",sort(unique(Vehdat$County))),
      function(cty) {
        
        vehdat <- Vehdat
        if(cty != "California") {
          vehdat <- Vehdat %>% filter(County==cty)
        }
        
        usedveh <- vehdat %>% filter(CNTV==1)
        
        res <- usedveh %>% 
          mutate(ystr=as.character(YEAR)) %>%
          mutate(AGE=ifelse(ystr %in% c("9998","9999"),
                            "Unknown",
                            ifelse(as.integer(ystr)<1992,">21",
                                   ifelse(as.integer(ystr)==2013,'<1',2013-as.integer(ystr)))),
                 MODEL.YEAR=ifelse(ystr %in% c("9998","9999"),
                                   "Not Known",
                                   ifelse(as.integer(ystr)<1992,"1991 or Earlier",YEAR))
          ) %>% 
          group_by(AGE,MODEL.YEAR) %>%
          summarise(n=sum(ifelse(grepl(paste("^",cty,"$",sep=""),County),NEXPHHWDCTYWGT,NEXPHHWDWGT)),
                    YEAR=min(as.integer(YEAR))) %>% 
          ungroup() %>%
          mutate(YEAR=ifelse(YEAR>9000,-YEAR,YEAR))
        rest <- res %>% ungroup() %>% mutate(YEAR=as.integer(YEAR)) %>%
          arrange(desc(YEAR)) %>% select(-YEAR)
        rest.2 <- rest %>% mutate(pct=n/sum(res$n)*100,cumpct=cumsum(n)/sum(res$n)*100)
        res.22 <- rest.2 %>% transmute(`Model Year`=MODEL.YEAR,
                                       `Age of Vehicle`=AGE,
                                       `Num of Veh in Use`=round(n,0),
                                       `Percent of Vehicles`=round(pct,1),
                                       `Cumulative Percent`=round(cumpct,1))
        res.22 <- rbind(res.22, rest.2 %>% summarise(`Model Year`=NA,
                                                     `Age of Vehicle`='TOTAL',
                                                     `Num of Veh in Use`=round(sum(rest.2$n),0),
                                                     `Percent of Vehicles`=NA,
                                                     `Cumulative Percent`=NA))
        return(
          pandoc.table.return(
            res.22,
            caption=paste("TABLE 22: Vehicles in Use on Average Weekday Distributed by Age of Vehicle by County (",cty,")",sep=""),
            split.table=Inf,split.cells=Inf,
            justify=c('center','center','right','right','right'),
            style='multiline',
            round=Inf,
            big.mark = ',',
            missing='&nbsp;'
            ,emphasize.strong.rows=which(res.22$`Age of Vehicle`=='TOTAL',arr.ind=TRUE)
          ))
        })
res[['22.str']] <- paste(t,collapse="\n\n")
  

```
```{r table-22-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['22.str']])
```


## TABLE 22a: Number of Vehicle Trips (VT), Number of Vehicle Miles Traveled (VMT) and Person Trips (PT) and Person Miles Traveled (PMT) by County by Mode and Purpose.

How to define VT?  By definition, Transit trips will have zero VMT, so having both VMT and mode split doesn't make sense to me.

## TABLE 50: Mode share for the trips under 1 mile, and trips under 3 miles for transit, bike, and walk by County

Also asked for cities, but samples sizes will be too small for most.

```{r t50}
dat <- chts_pla %>%  
  filter(PLANO!=1) %>%  # remove start of day
  filter(is.na(TripDistanceFlag) & TripDistance < 3) %>%  # weighting issue!
  mutate(oCTFIP=as.integer(lag(CTFIP))) %>%  # origin CTFIP
  left_join(fipsctyca %>% select(county_ansi,oCounty=County),
            by=c('oCTFIP'='county_ansi')) %>%
  filter(!is.na(oCounty)) %>%
  mutate(DIST=ifelse(TripDistance<1,'< 1 mile','1 to 3 miles'),
         Mode=ifelse(MODE==1,'Walk',
                     ifelse(MODE==2,'Bike',
                            ifelse(MODE %in% public.transit.trip.modes, 'Transit',
                                   'All Others'))))
t <- dat %>% 
  group_by(oCounty,DIST,Mode) %>% 
  summarise(n=sum(EXPTCFPERWGT,na.rm=TRUE))

tt <- t %>% ungroup() %>% 
  mutate(Mode='Total') %>% 
  group_by(oCounty,DIST,Mode) %>% summarise(n=sum(n))
t2 <- t %>% left_join(tt %>% select(oCounty,DIST,nt=n),by=c('oCounty','DIST')) %>%
  mutate(pct=round(100*n/nt,1))
res.50 <- t2 %>% select(oCounty,Mode,DIST,pct) %>% spread(DIST,pct) %>%
  arrange(oCounty,ifelse(Mode=='All Others','ZZZZ',Mode))

res[['50.str']] <-
  paste(
    lapply(
      sort(unique(fipsctyca$County)),
      function(cty) {
        return(pandoc.table.return(
          res.50 %>% filter(oCounty==cty) %>%
            select(-oCounty),
          caption=paste("TABLE 50: Mode Share for Short Distance Trips by County (",cty,")",sep=""),
          split.table=Inf,split.cells=Inf,
          justify=c('center','right','right'),
          style='multiline',
          round=Inf,
          big.mark = ','
        ))
      }),
    collapse="\n\n"
  )


```
```{r table-50-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['50.str']])
```


## TABLE 51: Driver trips, bike, walk and transit for millennial versus older age groups. 


```{r table-51}
# following pew: http://www.pewresearch.org/fact-tank/2015/01/16/this-year-millennials-will-overtake-baby-boomers/
millenials <- 18:35-(2015-2012)

dat <- chts_pla %>%  
  left_join(chts_per,by=c('SAMPN','PERNO')) %>%
  filter(AGE>14) %>%
  filter(PLANO!=1) %>%  # remove start of day
  mutate(Mode=ifelse(
    MODE %in% driver.trip.modes, 'Driver',
    ifelse(
      MODE %in% c(6), 'Passenger',
      ifelse(
        MODE %in% public.transit.trip.modes, 'Transit',
        ifelse(
          MODE==1,'Walk',
          ifelse(
            MODE==2, 'Bike',
            'All Others'
          )
        )
      )
    )
  ),
         Generation=ifelse(AGE %in% millenials,
                           'Millenials (15-32)',
                           'Older Generations'))

t <- dat %>% group_by(Generation,Mode) %>% summarise(n=sum(EXPTCFPERWGT,na.rm=TRUE))
tt <- dat %>% mutate(Mode='All Modes') %>% 
  group_by(Generation,Mode) %>% 
  summarise(n=sum(EXPTCFPERWGT,na.rm=TRUE))
t2 <- rbind(t) %>% ungroup()
res.51 <- t2 %>% left_join(tt %>% select(Generation,nt=n), by=c('Generation')) %>%
  transmute(Generation=Generation,Mode=Mode,n=n,pct=round(100*n/nt,1)) %>%
  select(Generation,Mode,pct) %>%
  spread(Generation,pct) %>%
  arrange(ifelse(Mode=='All Modes',-999,'A'),
          desc(`Millenials (15-32)`))

res[['51.str']] <-
  pandoc.table.return(
    res.51,
    caption=paste(
      "TABLE 51: Driver trips, bike, walk and transit for millennial versus older age groups. ",
      sep=""),
    split.table=Inf,split.cells=Inf,
    justify=c('center','right','right'),
    style='multiline',
    round=Inf,
    big.mark = ','
  )
```
```{r table-51-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['51.str']])
```

## TABLE 52: Statewide Commute trips (JTW) by Mode (Walk, Bike, Drive/Passenger, Transit) and other by Mode and Distance ranges:

```{r table-52}
 #0.00-0.50
#0.50-1.00
#1.00- 2.00
#2.00 – 5.00
#5.00 – 10.00
#10.00+
dat <- chts_lt %>%  
  filter(!is.na(tripdist) & !is.na(ltmode)) %>%
  filter(TripType=='HW') %>%
  left_join(chts_per,by=c('SAMPN','PERNO')) %>%
  mutate(
    Mode=ifelse(
      ltmode %in% driver.trip.modes, 'Driver',
      ifelse(
        ltmode %in% c(6), 'Passenger',
        ifelse(
          ltmode %in% public.transit.trip.modes, 'Transit',
          ifelse(
            ltmode %in% c(1),'Walk',
            ifelse(
              ltmode %in% c(2), 'Bike',
              'All Others'
            )
          )
        )
      )
    )) %>% 
  mutate(
    NEXPTCFPERWGT=EXPPERWGT*ltTCF,
    Distance=ifelse(
      tripdist < 0.5, '0.0 - 0.5mi',
      ifelse(
        tripdist < 1.0, '0.5 - 1.0mi',
        ifelse(
          tripdist < 2.0, '1.0 - 2.0mi',
          ifelse(
            tripdist < 5.0, '2.0 - 5.0mi',
            ifelse(
              tripdist < 10.0, '5.0 - 10.0mi',
              '10.0mi or greater'
            )
          )
        )
      )
    )
  )
```
```{r t52.1}
agg <- dat %>% group_by(Distance,Mode) %>% summarise(n=sum(NEXPTCFPERWGT))
aggt.dist <- dat %>% group_by(Distance) %>% summarise(n=sum(NEXPTCFPERWGT)) %>%
  mutate(Mode='All Modes')
agg.all <- rbind(agg,aggt.dist) %>%
  left_join(aggt.dist %>% select(Distance,nt=n),by=c('Distance')) %>%
  ungroup() %>%
  transmute(Distance=Distance,Mode=Mode,Trips=round(n,0),Pct=round(n/nt*100,1)) %>%
  as.data.frame() %>%
  select(-Trips) %>%
  spread(Mode,Pct) %>%
  arrange(as.double(gsub("^(\\d+\\.\\d+).*?$","\\1",Distance)))  %>%
  select(Distance,Driver,Passenger,Transit,Bike,Walk,`All Others`,`All Modes`)
res[['52.str']] <-
  pandoc.table.return(
    agg.all,
    caption=paste(
      "TABLE 52: Statewide Commute trips (HW) by Mode (Walk, Bike, Drive/Passenger, Transit) and other by Mode and Distance ranges",
      sep=""),
    split.table=Inf,split.cells=Inf,
    justify=rep('right',8),
    style='multiline',
    round=Inf,
    big.mark = ','
  )
```
```{r table-52-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['52.str']])
```


## TABLE 53: Statewide School trips by Mode (Walk, Bike, Drive/Passenger, Transit) and other by Mode and Distance ranges
```{r t53}
# get all linked trips with a school activity at the destination
lt.dat <- chts_act %>% select(SAMPN,PERNO,PLANO,ACTNO,APURP) %>% filter(APURP==17) %>%
  left_join(chts_lu_lt,by=c('SAMPN','PERNO','PLANO','ACTNO')) %>%
  group_by(linkedtripno) %>% summarise(n=n()) %>%
  select(linkedtripno) %>%
  left_join(chts_lt,by=c('linkedtripno'))

dat <- lt.dat %>%  
  filter(!is.na(tripdist) & !is.na(ltmode)) %>%
  left_join(chts_per,by=c('SAMPN','PERNO')) %>%
  mutate(
    Mode=ifelse(
      ltmode %in% driver.trip.modes, 'Driver',
      ifelse(
        ltmode %in% c(6), 'Passenger',
        ifelse(
          ltmode %in% public.transit.trip.modes, 'Transit',
          ifelse(
            ltmode %in% c(1),'Walk',
            ifelse(
              ltmode %in% c(2), 'Bike',
              'All Others'
            )
          )
        )
      )
    )) %>% 
  mutate(
    NEXPTCFPERWGT=EXPPERWGT*ltTCF,
    Distance=ifelse(
      tripdist < 0.25, '0.0 - 0.25mi',
      ifelse(
        tripdist < 0.5, '0.25 - 0.5mi',
        ifelse(
          tripdist < 1.0, '0.50 - 1.0mi',
          ifelse(
            tripdist < 2.0, '1.0 - 2.0mi',
              '2.0mi or greater'
            )
          )
        )
      )
    )
```
```{r t53.1}
agg <- dat %>% group_by(Distance,Mode) %>% summarise(n=sum(NEXPTCFPERWGT,na.rm=TRUE))
aggt.dist <- dat %>% group_by(Distance) %>% summarise(n=sum(NEXPTCFPERWGT,na.rm=TRUE)) %>%
  mutate(Mode='All Modes')
agg.all <- rbind(agg,aggt.dist) %>%
  left_join(aggt.dist %>% select(Distance,nt=n),by=c('Distance')) %>%
  ungroup() %>%
  transmute(Distance=Distance,Mode=Mode,Trips=round(n,0),Pct=round(n/nt*100,1)) %>%
  as.data.frame() %>%
  select(-Trips) %>%
  spread(Mode,Pct) %>%
  arrange(as.double(gsub("^(\\d+\\.\\d+).*?$","\\1",Distance)))  %>%
  select(Distance,Driver,Passenger,Transit,Bike,Walk,`All Others`,`All Modes`)
res[['53.str']] <- 
  pandoc.table.return(
    agg.all,
    caption=paste(
      "TABLE 51: Statewide School trips by Mode (Walk, Bike, Drive/Passenger, Transit) and other by Mode and Distance ranges",
      sep=""),
    split.table=Inf,split.cells=Inf,
    justify=rep('right',8),
    style='multiline',
    round=Inf,
    big.mark = ','
  )
```
```{r table-53-results,results='asis',echo=FALSE,cache=FALSE}
cat(res[['53.str']])
```

\newpage

# Complete Tables

\newpage

### All Tables

```{r dump-all,echo=FALSE,results='asis',cache=FALSE}
cat(paste("\\footnotesize\n\n",res,collapse="\n\n\\newpage\n\n")) 
```
