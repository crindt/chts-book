---
title: "Data Request for Del Norte County"
author: "Suman Mitra"
date: 'This version: `r (function() {f<-dir(); format(max(file.mtime(f[grepl("^.*\\.Rmd$",f)])), format="%B %d, %Y")})()`'
output:
  pdf_document:
    keep_tex: yes
    template: custom.latex
fontfamily: inconsolata
fontsize: 11pt
geometry: margin=1in
params:
  documentclass: article
  documentation: '`r if(exists("documentation")){documentation}else{documentation<-"false";documentation}`'
---

```{r dnc-setup-0,echo=FALSE,cache=FALSE}
if ( !exists("rd") ) { rd <<- gsub("(.*?chts-book[^/]*).*$","\\1",getwd()) } 
source(paste(rd,"R/setup-hooks.R",sep="/"))
write(paste("Using Root Directory",rd,"\n"),stderr())
```
# Question

This question asked for the following information for Del Norte county:


1. Trips by Mode
2. Modal split for driving alone
3. Trip distance by Mode
4. Trip duration by Mode
5. Trips by Purpose
6. Work trips by mode

# Summary and Methodology


In this subsection We generate tables by mode for total number of trips,
total trip distance, average trip distance, total trip duration,
average trip duration, and total number of trips for driving alone.
To calculate the drive alone numbers we extract data for total
travelers (`TOTTR=1`) and `MODE={5, 6, 7, 8, 10}` (i.e., drivers
of cars, trucks, or motorcycles). We also generate tables for the
total number of trips by trip purpose and for work trips by
mode. More specifically, we generate tables for total number of trips by
activity purpose since the trip purpose is given in the database as
activity purpose and there is more than one activity in many single
trips. We consider each activity as a trip and only consider the
purpose code (`APURP=9`) for work trips.  We generate every table for
both trips originating in and ending in Del Norte County. We use the
new county wide weights for Del Norte County to generate weighted
results for trips that originated in Del Norte County and statewide
weights to generate weighted results for trips that originated outside
of Del Norte County.


\ifmydocumentation

# R Code and Implementation


The following commands are used to generate the results.

## Trips to Del Norte County


### Mode split calculations


To obtain our results we need the place level table (with weights) that we computed in Section 4, 
so let us retrieve it.


```{r dnc-1, cache=TRUE}
# Set the working directory
setwd(pd("District 1/DelNorte County"))


#Import the place level with new weight csv file and give a new name
#nplace<- read.csv(pd("Weight/NewWeightData/nplacedata3032015.csv"), header=TRUE)
nplace<- read.csv(pd("Weight/NewWeightData/nplacedata932015.csv"), header=TRUE) 
names(nplace)
head(nplace)# Show first ten observations

# make sure CTFIP is an integer
nplace$CTFIP <- as.integer(nplace$CTFIP) %% 1000

```

Next, we find the origin county for each trip and convert the `MODE` codes into 
text descriptions:

```{r dnc-2,cache=TRUE}
# Create trip origin county 
# Need dplyr
library("dplyr")
nplacedata <- nplace %>%
  group_by(SAMPN,PERNO)%>%
  arrange(SAMPN,PERNO,PLANO) %>%
  mutate(OCTFIP=lag(CTFIP))

# For recoding Mode
nplacedata$Mode<-
  ifelse(nplacedata$MODE==1,"Walk",
  ifelse(nplacedata$MODE==2,"Bike",
  ifelse(nplacedata$MODE==3,"Wheelchair/Mobility Scooter",
  ifelse(nplacedata$MODE==4,"Other Non-Motorized",
  ifelse(nplacedata$MODE==5,"Auto/Van/Truck Driver",
  ifelse(nplacedata$MODE==6,"Auto /Van/Truck Passenger",
  ifelse(nplacedata$MODE==7,"Carpool/Vanpool",
  ifelse(nplacedata$MODE==8,"Motorcycle/Scooter/Moped",
  ifelse(nplacedata$MODE==9,"Taxi/Hired Car/Limo",
  ifelse(nplacedata$MODE==10,"Rental Car/Vehicle",
  ifelse(nplacedata$MODE==11,"Private shuttle ",
  ifelse(nplacedata$MODE==12,"Greyhound Bus",
  ifelse(nplacedata$MODE==13,"Plane",
  ifelse(nplacedata$MODE==14,"Other Private Transit",
  ifelse(nplacedata$MODE==15,"Local Bus,Rapid Bus",
  ifelse(nplacedata$MODE==16,"Express Bus/Commuter Bus",
  ifelse(nplacedata$MODE==17,"Premium Bus",
  ifelse(nplacedata$MODE==18,"School Bus",
  ifelse(nplacedata$MODE==19,"Public Transit Shuttle",
  ifelse(nplacedata$MODE==20,"Air BART/LAX Fly Away",
  ifelse(nplacedata$MODE==21,"Dial-a-Ride/Paratransit",
  ifelse(nplacedata$MODE==22,"Amtrak Bus",
  ifelse(nplacedata$MODE==23,"Other Bus ",
  ifelse(nplacedata$MODE==24,"BART,Metro Red/Purple Line",
  ifelse(nplacedata$MODE==25,"ACE, Amtrak, Cal train",
  ifelse(nplacedata$MODE==26,"Metro",
  ifelse(nplacedata$MODE==27,"Street Car/Cable Car",
  ifelse(nplacedata$MODE==28,"Other Rail",
  ifelse(nplacedata$MODE==29,"Ferry / Boat",
         "Don't Know/Refused"
         )))))))))))))))))))))))))))))
```


Now, let us focus on trips ending in Del Norte County.  Here we use
different weights depending on the origin of the trip: 
when the origin is Del Norte County, we use the Del Norte County 
weights, and when the origin is outside Del Norte County, we use the
statewide weights.

```{r dnc-3,cache=TRUE}
# Trips to Del Norte County
# Create a subset for trips to Del Norte county 
# We are only interested in trips to Del Norte County (CTFIP=15) 
# Create a subset for trips to Del Norte County 
place_15<-subset(nplacedata,CTFIP==15)
names(place_15)
# Change the weight for non Del Norte County origin
# (Assign state wide weight for non Del Norte origin)
place_15$NTCFW <-
  ifelse((place_15$OCTFIP==15),
         place_15$NEXPTCFPERWGT,
         place_15$EXPTCFPERWGT)
head(place_15)
```

The file `place_15$NTCFW` now contains the trips ending in Del Norte county
with appropriate expansion weights appended.  Now let us generate
observations for modal split for trips to Del Norte:

Notes: In the tables: Ob = Observations, Per = Percent, UW =
Unweighted and W = Weighted.

```{r dnc-4,cache=TRUE}
## Generate frequency for trip Mode
temp1<-as.data.frame(table(place_15$Mode))
## Create percentage of frequency
temp1$Percent<-temp1$Freq*100/sum(temp1$Freq)
## Names 
names(temp1)
## Rename the variables
colnames(temp1)[c(1:3)] <- c("Mode","Ob_UW","Per_UW")
## Show the results
temp1
```

Let us compute the weighted frequencies:

```{r dnc-5,cache=TRUE}
## Create weighted frequency
temp2<-aggregate(NTCFW~Mode,FUN=sum,data=place_15)
## Create weighted percentage
temp2$Percent<-temp2$NTCFW*100/sum(temp2$NTCFW)
## Names
names(temp2)
## Rename the variables
colnames(temp2)[c(1:3)] <- c("Mode","Ob_W","Per_W")
## Show
temp2
```

Let us save our results in a `csv` file (Mode_15d.csv) for later use.

```{r dnc-6,cache=TRUE}
## Merge the two files and save
temp3<-merge(temp1,temp2, by ="Mode", all = TRUE,sort=TRUE)
temp3 <- temp3[,c(1,2,4,3,5)]
temp3
Mode_15d<-temp3
temp3[,1]<-as.character(temp3[,1])
temp3<- rbind(temp3, c("Total", colSums(temp3[,2:5],na.rm = TRUE)))
temp3
## Save as csv file
write.csv(temp3,file=pto("Mode_15d.csv"),row.names=FALSE)
mode.dnc.dest <- temp3
rm(temp1)
rm(temp2)
rm(temp3)
```

### Trip duration by mode


We proceed similarly to find Total Trip duration for all
trips ending in Del Norte, by mode:

```{r dnc-7,cache=TRUE}
## Generate frequency for trip Mode
temp1<-aggregate(TRIPDUR~Mode,FUN=sum,data=place_15)
## Create  percentage
temp1$Percent<-temp1$TRIPDUR*100/sum(temp1$TRIPDUR)
## Names
names(temp1)
## Rename the variables
colnames(temp1)[c(1:3)] <- c("Mode","TDu_UW","Per_UW")
## Show
temp1
```

Let us compute weighted frequencies:

```{r dnc-8,cache=TRUE}
## Create weighted frequency
temp<-place_15$NTCFW*place_15$TRIPDUR
temp2<-aggregate(temp~Mode,FUN=sum,data=place_15)
## Create weighted percentage
temp2$Percent<-temp2$temp*100/sum(temp2$temp)
## Names
names(temp2)
## Rename the variables
colnames(temp2)[c(1:3)] <- c("Mode","TDu_W","Per_W")
## Show
temp2
```


And as before, we save the results for later use: 

```{r dnc-9,cache=TRUE}
## Merge the two files and save
temp3<-merge(temp1,temp2, by ="Mode", all = TRUE)
temp3 <- temp3[,c(1,2,4,3,5)]
# Average trip duration
temp3$avg_uw<-temp3$TDu_UW/Mode_15d$Ob_UW
temp3
temp3$avg_w<-temp3$TDu_W/Mode_15d$Ob_W
temp3
temp3[,1]<-as.character(temp3[,1])
temp3<- rbind(temp3, c("Total", colSums(temp3[,2:7],na.rm = TRUE)))
temp3
## Save as csv file
write.csv(temp3,file=pto("TripDUrm_D15.csv"),row.names=FALSE)
dur.dnc.dest <- temp3
rm(temp1)
rm(temp2)
rm(temp3)
rm(temp)
```

### Trip distance by mode

Moving on, we find Total Trip distance for all trips ending in
Del Norte County, by mode.

```{r dnc-10,cache=TRUE}
## Generate frequency for trip Mode
temp1<-aggregate(TripDistance~Mode,FUN=sum,data=place_15)
## Create  percentage
temp1$Percent<-temp1$TripDistance*100/sum(temp1$TripDistance)
## Names
names(temp1)
## Rename the variables
colnames(temp1)[c(1:3)] <- c("Mode","TDis_UW","Per_UW")
## Show
temp1
```

Next, we compute weighted trip distances by mode:

```{r dnc-11,cache=TRUE}
## Create weighted frequency
temp<-place_15$NTCFW*place_15$TripDistance
temp2<-aggregate(temp~Mode,FUN=sum,data=place_15)
## Create weighted percentage
temp2$Percent<-temp2$temp*100/sum(temp2$temp)
## Names
names(temp2)
## Rename the variables
colnames(temp2)[c(1:3)] <- c("Mode","TDis_W","Per_W")
## Show
temp2
```

And, we save the results in a csv file for later use:

```{r dnc-12,cache=TRUE}
## Merge the two files and save
temp3<-merge(temp1,temp2, by ="Mode", all = TRUE)
temp3 <- temp3[,c(1,2,4,3,5)]
# Average trip distance
temp3$avg_uw<-temp3$TDis_UW/Mode_15d$Ob_UW
temp3
temp3$avg_w<-temp3$TDis_W/Mode_15d$Ob_W
temp3
temp3[,1]<-as.character(temp3[,1])
temp3<- rbind(temp3, c("Total", colSums(temp3[,2:7],na.rm = TRUE)))
temp3
## Save as csv file
write.csv(temp3,file=pto("TripDistanceM_D15.csv"),row.names=FALSE)
dist.dnc.dest <- temp3
rm(temp1)
rm(temp2)
rm(temp3)
rm(temp)
```

### Modal split for driving alone

The next task is to find the modal split for "Drive Alone". To perform this task, 
we first subset the data based on `TOTTR` (Total travelers) and
`MODE={5, 6, 7, 8, 10}` (essentially drivers of cars, trucks, or
motorcycles):

```{r dnc-13}
place_15d<-subset(place_15,(TOTTR==1 & (MODE==5|MODE==6|MODE==7|MODE==8|MODE==10)))
head(place_15d)
```

We then compute the frequency of each mode:

```{r dnc-14}
## Create frequency for different Mode category for drive alone
temp1<-as.data.frame(table(place_15d$Mode))
## Create percentage of frequency
temp1$Percent<-temp1$Freq*100/sum(temp1$Freq)
## Names 
names(temp1)
## Rename the variables
colnames(temp1)[c(1:3)] <- c("Mode","Ob_UW","Per_UW")
## Show the results
temp1
```

And now we compute weighted frequencies:

```{r dnc-15}
## Create weighted frequency
temp2<-aggregate(NTCFW~Mode,FUN=sum,data=place_15d)
## Create weighted percentage
temp2$Percent<-temp2$NTCFW*100/sum(temp2$NTCFW)
## Names
names(temp2)
## Rename the variables
colnames(temp2)[c(1:3)] <- c("Mode","Ob_W","Per_W")
## Show
temp2
```

Save the results in a csv file for later use:

```{r dnc-16}

## Merge the two files and save
temp3<-merge(temp1,temp2, by ="Mode", all = TRUE,sort=FALSE)
temp3 <- temp3[,c(1,2,4,3,5)]
temp3
temp3[,1]<-as.character(temp3[,1])
temp3<- rbind(temp3, c("Total", colSums(temp3[,2:5],na.rm = TRUE)))
temp3
## Save as csv file
write.csv(temp3,file=pto("Mode_15Ddrialn.csv"),row.names=FALSE)
mode.da.dnc.dest <- temp3
rm(temp1)
rm(temp2)
rm(temp3)
```


## Trips from Del Norte County

We are done with trips to Del Norte so let perform a similar procedure for trips from Del Norte
County.  We start by subseting the place data, but this time for trips
originating in Del Norte County:

```{r dnc-17,cache=TRUE}

# Let us estimate trips from Del Norte county (OCTFIP=15) 
# Create a subset for trips from Del Norte county 
place_15O<-subset(nplacedata,OCTFIP==15)
names(place_15O)
head(place_15O)
```

### Trips by mode


Now let us generate the mode frequency table for all trips from Del Norte
County:

```{r dnc-18,cache=TRUE}
# Generate observations for modal split for trips from Del Norte based on new weights
## Generate frequency for trip Mode
temp1<-as.data.frame(table(place_15O$Mode))
## Create percentage of frequency
temp1$Percent<-temp1$Freq*100/sum(temp1$Freq)
## Names 
names(temp1)
## Rename the variables
colnames(temp1)[c(1:3)] <- c("Mode","Ob_UW","Per_UW")
## Show the results
temp1
```

This should be looking familiar by now. Here are the weighted frequencies:

```{r dnc-19,cache=TRUE}
## Create weighted frequency
temp2<-aggregate(NEXPTCFPERWGT~Mode,FUN=sum,data=place_15O)
## Create weighted percentage
temp2$Percent<-temp2$NEXPTCFPERWGT*100/sum(temp2$NEXPTCFPERWGT)
## Names
names(temp2)
## Rename the variables
colnames(temp2)[c(1:3)] <- c("Mode","Ob_W","Per_W")
## Show
temp2
```

Save results in a csv file for later use:

```{r dnc-20,cache=TRUE}
## Merge the two files and save
temp3<-merge(temp1,temp2, by ="Mode", all = TRUE,sort=FALSE)
temp3 <- temp3[,c(1,2,4,3,5)]
temp3
Mode_15O<-temp3
temp3[,1]<-as.character(temp3[,1])
temp3<- rbind(temp3, c("Total", colSums(temp3[,2:5],na.rm = TRUE)))
temp3
## Save as csv file
write.csv(temp3,file=pto("Mode_15O.csv"),row.names=FALSE)
mode.dnc.orig <- temp3
rm(temp1)
rm(temp2)
rm(temp3)
```

### Trip duration by Mode


Repeat for trip durations originating in Del Norte:

```{r dnc-21,cache=TRUE}
## Total Trip duration for all trips from Del Norte, by Mode
## Generate frequency for trip Mode
temp1<-aggregate(TRIPDUR~Mode,FUN=sum,data=place_15O)
## Create  percentage
temp1$Percent<-temp1$TRIPDUR*100/sum(temp1$TRIPDUR)
## Names
names(temp1)
## Rename the variables
colnames(temp1)[c(1:3)] <- c("Mode","TDu_UW","Per_UW")
## Show
temp1
```

Here are the weighted frequency calculations:

```{r dnc-22,cache=TRUE}
## Create weighted frequency
temp<-place_15O$NEXPTCFPERWGT*place_15O$TRIPDUR
temp2<-aggregate(temp~Mode,FUN=sum,data=place_15O)
## Create weighted percentage
temp2$Percent<-temp2$temp*100/sum(temp2$temp)
## Names
names(temp2)
## Rename the variables
colnames(temp2)[c(1:3)] <- c("Mode","TDu_W","Per_W")
## Show
temp2
```

Save the results in a csv file:

```{r dnc-23,cache=TRUE}
## Merge the two files and save
temp3<-merge(temp1,temp2, by ="Mode", all = TRUE)
temp3 <- temp3[,c(1,2,4,3,5)]
temp3
temp3$avg_uw<-temp3$TDu_UW/Mode_15O$Ob_UW
temp3
temp3$avg_w<-temp3$TDu_W/Mode_15O$Ob_W
temp3
temp3[,1]<-as.character(temp3[,1])
temp3<- rbind(temp3, c("Total", colSums(temp3[,2:7],na.rm = TRUE)))
temp3
## Save as csv file
write.csv(temp3,file=pto("TripDUrm_O.csv"),row.names=FALSE)
dur.dnc.orig <- temp3
rm(temp1)
rm(temp2)
rm(temp3)
rm(temp)
```

### Trip distance by Mode


Here are the trip distance calculations for all trips from Del Norte, by
Mode.

```{r dnc-24,cache=TRUE}
## Generate frequency for trip Mode
temp1<-aggregate(TripDistance~Mode,FUN=sum,data=place_15O)
## Create  percentage
temp1$Percent<-temp1$TripDistance*100/sum(temp1$TripDistance)
## Names
names(temp1)
## Rename the variables
colnames(temp1)[c(1:3)] <- c("Mode","TDis_UW","Per_UW")
## Show
temp1
```

Following the same blueprint as above, let us now calculate weighted frequencies:

```{r dnc-25,cache=TRUE}
## Create weighted frequency
temp<-place_15O$NEXPTCFPERWGT*place_15O$TripDistance
temp2<-aggregate(temp~Mode,FUN=sum,data=place_15O)
## Create weighted percentage
temp2$Percent<-temp2$temp*100/sum(temp2$temp)
## Names
names(temp2)
## Rename the variables
colnames(temp2)[c(1:3)] <- c("Mode","TDis_W","Per_W")
## Show
temp2
```

and let us now save results in a csv file:

```{r dnc-26,cache=TRUE}
## Merge the two files and save
temp3<-merge(temp1,temp2, by ="Mode", all = TRUE)
temp3 <- temp3[,c(1,2,4,3,5)]
temp3
temp3$avg_uw<-temp3$TDis_UW/Mode_15O$Ob_UW
temp3
temp3$avg_w<-temp3$TDis_W/Mode_15O$Ob_W
temp3
temp3[,1]<-as.character(temp3[,1])
temp3<- rbind(temp3, c("Total", colSums(temp3[,2:7],na.rm = TRUE)))
temp3
## Save as csv file
write.csv(temp3,file=pto("TripDistanceM_O.csv"),row.names=FALSE)
dist.dnc.orig <- temp3
rm(temp1)
rm(temp2)
rm(temp3)
rm(temp)
```

### Modal split for driving alone

Lastly for trips originating in Del Norte County, here is the drive alone modal
split.  As before, we subset the data based on `TOTTR` (Total
travelers) and `MODE={5, 6, 7, 8, 10}` (drivers of cars, trucks, or
motorcycles):

```{r dnc-27,cache=TRUE} 
place_15dO<-subset(place_15O,(TOTTR==1 & (MODE==5|MODE==6|MODE==7|MODE==8|MODE==10)))
head(place_15dO)
```

The raw frequency table can be obtained from:

```{r dnc-28,cache=TRUE}
## Create frequency for different mode category for drive alone
temp1<-as.data.frame(table(place_15dO$Mode))
## Create percentage of frequency
temp1$Percent<-temp1$Freq*100/sum(temp1$Freq)
## Names 
names(temp1)
## Rename the variables
colnames(temp1)[c(1:3)] <- c("Mode","Observations_UW","Percent_UW")
## Show the results
temp1
```

Let us now create a weighted frequency table:

```{r dnc-29,cache=TRUE}
## Create weighted frequency
temp2<-aggregate(NEXPTCFPERWGT~Mode,FUN=sum,data=place_15dO)
## Create weighted percentage
temp2$Percent<-temp2$NEXPTCFPERWGT*100/sum(temp2$NEXPTCFPERWGT)
## Names
names(temp2)
## Rename the variables
colnames(temp2)[c(1:3)] <- c("Mode","Observations_W","Percent_W")
## Show
temp2
```

Let us save the results in a csv file:

```{r dnc-30,cache=TRUE}
## Merge the two files and save
temp3<-merge(temp1,temp2, by ="Mode", all = TRUE,sort=FALSE)
temp3 <- temp3[,c(1,2,4,3,5)]
temp3
temp3[,1]<-as.character(temp3[,1])
temp3<- rbind(temp3, c("Total", colSums(temp3[,2:5],na.rm = TRUE)))
temp3
## Save as csv file
write.csv(temp3,file=pto("Mode_15Odrialn.csv"),row.names=FALSE)
mode.da.dnc.orig <- temp3
rm(temp1)
rm(temp2)
rm(temp3)
```

## Trip Purpose Calculations

Now we want to find the trip purpose breakdown, so we import the activity
level data with the appropriate weights.  Let us load the data and merge them:

```{r dnc-31,cache=TRUE}
#Import the activity level data frame and give a new name
library(chts2011)
act_data <- chts_act
names(act_data)

# Merge the person weight file with place level data file
act_place<-merge(act_data,nplacedata,
                 by =c("SAMPN","PERNO","PLANO"), all = FALSE)
names(act_place)
```

For display purposes, we convert the purpose codes into readable strings:

```{r dnc-32, cache=TRUE}
act_place$Actpur <-
  ifelse(act_place$APURP==1," Personal Activities",
  ifelse(act_place$APURP==2," Preparing Meals/Eating",
  ifelse(act_place$APURP==3," Hosting Visitors/Entertaining Guests",
  ifelse(act_place$APURP==4," Exercise ",
  ifelse(act_place$APURP==5," Study/Schoolwork ",
  ifelse(act_place$APURP==6," Work For Pay At Home Using ",
  ifelse(act_place$APURP==7," Using Computer/Telephone/Cell Or Smart Phone",
  ifelse(act_place$APURP==8," All Other Activities At My Home ",
  ifelse(act_place$APURP==9," Work/Job Duties ",
  ifelse(act_place$APURP==10," Training",
  ifelse(act_place$APURP==11," Meals At Work ",
  ifelse(act_place$APURP==12," Work-Sponsored Social Activities ",
  ifelse(act_place$APURP==13," Non-Work Related Activities",
  ifelse(act_place$APURP==14," Exercise/Sports ",
  ifelse(act_place$APURP==15," Volunteer Work/Activities",
  ifelse(act_place$APURP==16," All Other Work-Related Activities At My Work ",
  ifelse(act_place$APURP==17," In School/Classroom/Laboratory ",
  ifelse(act_place$APURP==18," Meals At School/College ",
  ifelse(act_place$APURP==19," After School Sports/Physical Activity ",
  ifelse(act_place$APURP==20," All Other After School Related Activities ",
  ifelse(act_place$APURP==21," Change Type Of Transportation/Transfer ", 
  ifelse(act_place$APURP==22," Pickup/Drop Off Passenger(S)", 
  ifelse(act_place$APURP==23," Drive Through Meals ", 
  ifelse(act_place$APURP==24," Drive Through Other (ATM, Bank) ",
  ifelse(act_place$APURP==25," Work-Related",
  ifelse(act_place$APURP==26," Service Private Vehicle",
  ifelse(act_place$APURP==27," Routine Shopping ",
  ifelse(act_place$APURP==28," Shopping For Major Purchases",
  ifelse(act_place$APURP==29," Household Errands", 
  ifelse(act_place$APURP==30," Personal Business ", 
  ifelse(act_place$APURP==31," Eat Meal at Restaurant/Diner", 
  ifelse(act_place$APURP==32," Health Care", 
  ifelse(act_place$APURP==33," Civic/Religious Activities", 
  ifelse(act_place$APURP==34," Outdoor Exercise", 
  ifelse(act_place$APURP==35," Indoor Exercise", 
  ifelse(act_place$APURP==36," Entertainment ", 
  ifelse(act_place$APURP==37," Social/Visit Friends/Relatives", 
  ifelse(act_place$APURP==38," Other ", 
  ifelse(act_place$APURP==39," Loop Trip", 
         " Don't Know/Refused"
         )))))))))))))))))))))))))))))))))))))))
head(act_place)
```

### Trip Purposes from Del Norte County


We start with trips from Del Norte County, subsetting based on the
origin county `OCTFIP=15`:

```{r dnc-33, cache=TRUE}
# Now we are interested in trips from Del Norte county (OCTFIP=15) 
# Create a subset for trips from Del Norte County 
act_15O<-subset(act_place,OCTFIP==15)
names(act_15O)
head(act_15O)
```

Next, we combine observations by trip purpose for trips from Del
Norte with the new county weights:

```{r dnc-34,cache=TRUE}
## Generate frequency for trip Mode
temp1<-as.data.frame(table(act_15O$Actpur))
## Create percentage of frequency
temp1$Percent<-temp1$Freq*100/sum(temp1$Freq)
## Names 
names(temp1)
## Rename the variables
colnames(temp1)[c(1:3)] <- c("Actpur","Ob_UW","Per_UW")
## Show the results
temp1
```

Let us now calculate weighted trip purpose frequencies:

```{r dnc-35,cache=TRUE}
## Create weighted frequency
temp2<-aggregate(NEXPTCFPERWGT~Actpur,FUN=sum,data=act_15O)
## Create weighted percentage
temp2$Percent<-temp2$NEXPTCFPERWGT*100/sum(temp2$NEXPTCFPERWGT)
## Names
names(temp2)
## Rename the variables
colnames(temp2)[c(1:3)] <- c("Actpur","Ob_W","Per_W")
## Show
temp2
```

And here we save our results is a csv file:

```{r dnc-36}
## Merge the two files and save
temp3<-merge(temp1,temp2, by ="Actpur", all = TRUE,sort=FALSE)
temp3 <- temp3[,c(1,2,4,3,5)]
temp3
temp3[,1]<-as.character(temp3[,1])
temp3<- rbind(temp3, c("Total", colSums(temp3[,2:5],na.rm = TRUE)))
temp3
## Save as csv file
write.csv(temp3,file=pto("Actpur_15O.csv"),row.names=FALSE)
apurp.dnc.orig <- temp3
rm(temp1)
rm(temp2)
rm(temp3)
```


## Work Trips by Mode


In the remainder of this sub-section, let us find work trips by mode for Del Norte County.  


### Work Trips Originating in Del Norte County

First, we reuse the merged activity table from above for trips
activities (and associated trips) originating in Del Norte County, and
subset it for work trips only:

```{r dnc-37}
# Create a subset for work trips
actw_15O<-subset(act_15O,APURP==9)
```

Now, we can find the observations for each mode used for work trips:

```{r dnc-38,cache=TRUE}
## Generate frequency for trip Mode
temp1<-as.data.frame(table(actw_15O$Mode))
## Create percentage of frequency
temp1$Percent<-temp1$Freq*100/sum(temp1$Freq)
## Names 
names(temp1)
## Rename the variables
colnames(temp1)[c(1:3)] <- c("Mode","Ob_UW","Per_UW")
## Show the results
temp1
```

Let us expand these observations using the weights for Del Norte County:

```{r dnc-39,cache=TRUE}
## Create weighted frequency
temp2<-aggregate(NEXPTCFPERWGT~Mode,FUN=sum,data=actw_15O)
## Create weighted percentage
temp2$Percent<-temp2$NEXPTCFPERWGT*100/sum(temp2$NEXPTCFPERWGT)
## Names
names(temp2)
## Rename the variables
colnames(temp2)[c(1:3)] <- c("Mode","Ob_W","Per_W")
## Show
temp2
```

We now save our results:

```{r dnc-40,cache=TRUE}
## Merge the two files and save
temp3<-merge(temp1,temp2, by ="Mode", all = TRUE,sort=FALSE)
temp3 <- temp3[,c(1,2,4,3,5)]
temp3
temp3[,1]<-as.character(temp3[,1])
temp3<- rbind(temp3, c("Total", colSums(temp3[,2:5],na.rm = TRUE)))
temp3
## Save as csv file
write.csv(temp3,file=pto("Mode_wact15O.csv"),row.names=FALSE)
dnc.mode.wact.orig <- temp3
rm(temp1)
rm(temp2)
rm(temp3)
```

### Work Trips Ending in Del Norte County


Now let us find trips ending in Del Norte county `(CTFIP=15)`.
We subset the place table and use Del Norte County weights for origins in Del Norte, and use statewide
weights for origins outside of Del Norte County.


```{r dnc-41,cache=TRUE}
# Create a subset for trips from Del Norte County 
act_15D<-subset(act_place,CTFIP==15)
names(act_15D)
head(act_15D)
# Change the weight for non Del Norte county origin (Assign state wide weight for non Del Norte origin)
act_15D$NTCFW <- ifelse((act_15D$OCTFIP==15), act_15D$NEXPTCFPERWGT, act_15D$EXPTCFPERWGT.y)
names(act_15D)
head(act_15D)
```

Generate a frequency table by purpose:

```{r dnc-42,cache=TRUE}
# Generate observations by trip purpose from Del Norte based on new weights
## Generate frequency for trip Mode
temp1<-as.data.frame(table(act_15D$Actpur))
## Create percentage of frequency
temp1$Percent<-temp1$Freq*100/sum(temp1$Freq)
## Names 
names(temp1)
## Rename the variables
colnames(temp1)[c(1:3)] <- c("Actpur","Ob_UW","Per_UW")
## Show the results
temp1
```

Create a weighted frequency table:

```{r dnc-43,cache=TRUE}
## Create weighted frequency
temp2<-aggregate(NTCFW~Actpur,FUN=sum,data=act_15D)
## Create weighted percentage
temp2$Percent<-temp2$NTCFW*100/sum(temp2$NTCFW)
## Names
names(temp2)
## Rename the variables
colnames(temp2)[c(1:3)] <- c("Actpur","Ob_W","Per_W")
## Show
temp2
```

And now we save the result in a csv file:

```{r dnc-44,cache=TRUE}
## Merge the two files and save
temp3<-merge(temp1,temp2, by ="Actpur", all = TRUE,sort=FALSE)
temp3 <- temp3[,c(1,2,4,3,5)]
temp3
temp3[,1]<-as.character(temp3[,1])
temp3<- rbind(temp3, c("Total", colSums(temp3[,2:5],na.rm = TRUE)))
temp3
## Save as csv file
write.csv(temp3,file=pto("Actpur_15D.csv"),row.names=FALSE)
apurp.dnc.dest <- temp3
rm(temp1)
rm(temp2)
rm(temp3)
```

Finally, we compute the frequencies of various modes used for work trips ending
in Del Norte County:

```{r dnc-45,cache=TRUE}
# We want only work trips (APURP=9)
# Create a subset for work trips
actw_15D<-subset(act_15D,APURP==9)
## Generate frequency for trip Mode
temp1<-as.data.frame(table(actw_15D$Mode))
## Create percentage of frequency
temp1$Percent<-temp1$Freq*100/sum(temp1$Freq)
## Names 
names(temp1)
## Rename the variables
colnames(temp1)[c(1:3)] <- c("Mode","Ob_UW","Per_UW")
## Show the results
temp1
```

Here is the weighted frequency table:

```{r dnc-46,cache=TRUE}
## Create weighted frequency
temp2<-aggregate(NTCFW~Mode,FUN=sum,data=actw_15D)
## Create weighted percentage
temp2$Percent<-temp2$NTCFW*100/sum(temp2$NTCFW)
## Names
names(temp2)
## Rename the variables
colnames(temp2)[c(1:3)] <- c("Mode","Ob_W","Per_W")
## Show
temp2
## Merge the two files and save
temp3<-merge(temp1,temp2, by ="Mode", all = TRUE,sort=FALSE)
temp3 <- temp3[,c(1,2,4,3,5)]
temp3
temp3[,1]<-as.character(temp3[,1])
temp3<- rbind(temp3, c("Total", colSums(temp3[,2:5],na.rm = TRUE)))
temp3
```

...and one last time we save results:

```{r dnc-47,cache=TRUE}
## Save as csv file
write.csv(temp3,file=pto("Mode_wact15D.csv"),row.names=FALSE)
dnc.mode.wact.dest <- temp3
rm(temp1)
rm(temp2)
rm(temp3)
```

We have completed the tasks we wanted to acomplish in this subsection.


## Generate similar statistics for other counties

We can generate similar tables for other counties (e.g., Humboldt,
Lake, and Mendocino County) using the commands above with only a minor
changes: the data need to be subsetted using the correct county fip
number.

For example, let us assume we want to generate statistics for Hubmoldt
County, which has a county fip number of 23.  Where the existing code
for DelNorte county is `place_15<-subset(nplacedata,CTFIP==15)`, we
would instead write: `place_23<-subset(nplacedata,CTFIP==23)`.  We
also need to use the new file `place_23` in the rest of the code. For
example, to generate the frequency for trip Mode we used the following
code for DelNorte county:
`temp1<-as.data.frame(table(place_15$Mode))`.  To obtain trip
frequencies for Humboldt County, we need to change it to:
`temp1<-as.data.frame(table(place_23$Mode))`.  We need to make the
same change when we work with the activity file.  For example,
`act_15O<-subset(act_place,OCTFIP==15)` needs to be changed to
`act_23O<-subset(act_place,OCTFIP==23)`.  In short, we simply need to
change the county fip nubmer everywhere in the R program.  Likewise,
to generate tables for Lake and Mendocino county, We would change the
county fip nubmer to 33 and 45 resepectively everywhere in the R
program where the county fip number appears.

\fi

\newpage

# Results

```{r dnc-mode-code,echo=FALSE,results='asis'}
mmap <- nplacedata %>%
    group_by(MODE,Mode) %>% summarise(n=n())
pandoc.table.double(
    mmap %>%
    select(Code=MODE,Mode),
    caption="Mode Code",
    justify=c('left','left'),
    split.cells=Inf,
    missing="&nbsp;")
```

\newpage

```{r dnc-act-purp-code,echo=FALSE,results='asis'}
amap <- act_place %>%
    group_by(APURP,Actpur) %>% summarise(n=n())
pandoc.table.double(
    amap %>% select(Code=APURP,Purpose=Actpur),
    caption="Activity Purpose Code",
    justify=c('left','left'),
    split.cells=c('10%','90%'),
    split.table=100,
  missing='&nbsp;')
```

\newpage

```{r mode.dnc.orig,echo=FALSE,results='asis'}
mode.dnc.orig <- mode.dnc.orig %>%
  arrange(ifelse(Mode=="Total",1,0),desc(as.numeric(Ob_W))) %>%
  transmute(Mode=Mode,
            'Observed Unweighted'=format(round(as.numeric(Ob_UW),0),big.mark=','),
            'Observed Weighted'=format(round(as.numeric(Ob_W),0),big.mark=','),
            'Percent Unweighted'=format(round(as.numeric(Per_UW),2),big.mark=','),
            'Percent Weighted'=format(round(as.numeric(Per_W),2),big.mark=','))
#dnc.mode.orig2[,4:5] <- format(round(as.numeric(dnc.mode.orig2[,4:5]),2))
pandoc.table(
    mode.dnc.orig,
    caption="Total number of trips originating in Del Norte County",
    justify=c('left','right','right','right','right'),
    split.tables=100,
    split.cells=c('40%','15%','15%','15%','15%'),
    big.mark=",",
    emphasize.strong.rows=which(mode.dnc.orig$Mode=='Total',arr.ind=TRUE)
)
```

```{r mode.da.dnc.orig,echo=FALSE,results='asis'}
mode.da.dnc.orig <- mode.da.dnc.orig %>%
  arrange(ifelse(Mode=="Total",1,0),desc(as.numeric(Observations_W))) %>%
  transmute(Mode=Mode,
            'Observed Unweighted'=format(round(as.numeric(Observations_UW),0),big.mark=','),
            'Observed Weighted'=format(round(as.numeric(Observations_W),0),big.mark=','),
            'Percent Unweighted'=format(round(as.numeric(Percent_UW),2),big.mark=','),
            'Percent Weighted'=format(round(as.numeric(Percent_W),2),big.mark=','))
pandoc.table(
    mode.da.dnc.orig,
    caption="Modal split (drive alone) of trips originating in Del Norte County",
    justify=c('left','right','right','right','right'),
    split.tables=100,
    split.cells=c('40%','15%','15%','15%','15%'),
    big.mark=",",
    emphasize.strong.rows=which(mode.da.dnc.orig$Mode=='Total',arr.ind=TRUE)
)
```

\newpage

```{r dist.dnc.orig,echo=FALSE,results='asis'}
dist.dnc.orig <- dist.dnc.orig %>%
  arrange(ifelse(Mode=="Total",1,0),desc(as.numeric(TDis_W))) %>%
  transmute('Mode'=Mode,
            'Trip&nbsp;Dist UW'=format(round(as.numeric(TDis_UW),0),big.mark=','),
            'Trip&nbsp;Dist W'=format(round(as.numeric(TDis_W),0),big.mark=','),
            'Percent UW'=format(round(as.numeric(Per_UW),2),big.mark=','),
            'Percent W'=format(round(as.numeric(Per_W),2),big.mark=','),
            'Avg Dist UW'=format(round(as.numeric(avg_uw),2),big.mark=','),
            'Avg Dist W'=format(round(as.numeric(avg_w),2),big.mark=',')
            )
pandoc.table(
    dist.dnc.orig,
    caption="Trip distance (mi) by mode for trips originating in Del Norte County",
    justify=c('left','right','right','right','right','right','right'),
    split.tables=120,
    split.cells=c('20%','15%','25%','10%','10%','10%','10%'),
    big.mark=",",
    emphasize.strong.rows=which(dist.dnc.orig$Mode=='Total',arr.ind=TRUE)
)
```

\newpage

```{r dur.dnc.orig,echo=FALSE,results='asis'}
dur.dnc.orig <- dur.dnc.orig %>%
  arrange(ifelse(Mode=="Total",1,0),desc(as.numeric(TDu_W))) %>%
  transmute(Mode=Mode,
            'Trip&nbsp;Dur UW'=format(round(as.numeric(TDu_UW),0),big.mark=','),
            'Trip&nbsp;Dur W'=format(round(as.numeric(TDu_W),0),big.mark=','),
            'Percent UW'=format(round(as.numeric(Per_UW),2),big.mark=','),
            'Percent W'=format(round(as.numeric(Per_W),2),big.mark=','),
            'Avg Dur UW'=format(round(as.numeric(avg_uw),2),big.mark=','),
            'Avg Dur W'=format(round(as.numeric(avg_w),2),big.mark=',')
            )
pandoc.table(
    dur.dnc.orig,
    caption="Trip duration (min) by mode for trips originating in Del Norte County",
    justify=c('left','right','right','right','right','right','right'),
    split.tables=120,
    split.cells=c('20%','15%','25%','10%','10%','10%','10%'),
    big.mark=",",
    emphasize.strong.rows=which(dur.dnc.orig$Mode=='Total',arr.ind=TRUE)
)
```

\newpage

```{r apurp.dnc.orig,echo=FALSE,results='asis'}
apurp.dnc.orig <- apurp.dnc.orig %>%
  arrange(ifelse(Actpur=="Total",1,0),desc(as.numeric(Ob_W))) %>%
  transmute('Activity Purpose'=Actpur,
            'Obs UW'=format(round(as.numeric(Ob_UW),0),big.mark=','),
            'Obs W'=format(round(as.numeric(Ob_W),0),big.mark=','),
            'Pct UW'=format(round(as.numeric(Per_UW),2),big.mark=','),
            'Pct W'=format(round(as.numeric(Per_W),2),big.mark=',')
            )
pandoc.table(
  apurp.dnc.orig,
  caption="Total number of work trips (APURP=9) for trips originating in Del Norte County",
  justify=c('left','right','right','right','right'),
  split.tables=120,
  split.cells=c('60%','10%','10%','10%','10%'),
  big.mark=",",
  emphasize.strong.rows=which(apurp.dnc.orig$'Activity Purpose'=='Total',arr.ind=TRUE)
)
```

```{r dnc.mode.wact.orig,echo=FALSE,results='asis'}
dnc.mode.wact.orig <- dnc.mode.wact.orig %>%
  arrange(ifelse(Mode=="Total",1,0),desc(as.numeric(Ob_W))) %>%
  transmute(Mode=Mode,
            'Obs UW'=format(round(as.numeric(Ob_UW),0),big.mark=','),
            'Obs W'=format(round(as.numeric(Ob_W),0),big.mark=','),
            'Pct UW'=format(round(as.numeric(Per_UW),2),big.mark=','),
            'Pct W'=format(round(as.numeric(Per_W),2),big.mark=',')
            )
pandoc.table(
  dnc.mode.wact.orig,
  caption="Total number of trips by activity purpose for trips originating in Del Norte County",
  justify=c('left','right','right','right','right'),
  split.tables=120,
  split.cells=c('60%','10%','10%','10%','10%'),
  big.mark=",",
  emphasize.strong.rows=which(dnc.mode.wact.orig$Mode=='Total',arr.ind=TRUE)
)
```


<!-- Destinations --->

\newpage

```{r mode.dnc.dest,echo=FALSE,results='asis'}
mode.dnc.dest <- mode.dnc.dest %>%
  arrange(ifelse(Mode=="Total",1,0),desc(as.numeric(Ob_W))) %>%
  transmute(Mode=Mode,
            'Observed Unweighted'=format(round(as.numeric(Ob_UW),0),big.mark=','),
            'Observed Weighted'=format(round(as.numeric(Ob_W),0),big.mark=','),
            'Percent Unweighted'=format(round(as.numeric(Per_UW),2),big.mark=','),
            'Percent Weighted'=format(round(as.numeric(Per_W),2),big.mark=','))
#dnc.mode.dest2[,4:5] <- format(round(as.numeric(dnc.mode.dest2[,4:5]),2))
pandoc.table(
    mode.dnc.dest,
    caption="Total number of trips ending in Del Norte County",
    justify=c('left','right','right','right','right'),
    split.tables=100,
    split.cells=c('40%','15%','15%','15%','15%'),
    big.mark=",",
    emphasize.strong.rows=which(mode.dnc.dest$Mode=='Total',arr.ind=TRUE)
)
```

```{r mode.da.dnc.dest,echo=FALSE,results='asis'}
mode.da.dnc.dest <- mode.da.dnc.dest %>%
  arrange(ifelse(Mode=="Total",1,0),desc(as.numeric(Ob_W))) %>%
  transmute(Mode=Mode,
            'Observed Unweighted'=format(round(as.numeric(Ob_UW),0),big.mark=','),
            'Observed Weighted'=format(round(as.numeric(Ob_W),0),big.mark=','),
            'Percent Unweighted'=format(round(as.numeric(Per_UW),2),big.mark=','),
            'Percent Weighted'=format(round(as.numeric(Per_W),2),big.mark=','))
pandoc.table(
    mode.da.dnc.dest,
    caption="Modal split (drive alone) of trips ending in Del Norte County",
    justify=c('left','right','right','right','right'),
    split.tables=100,
    split.cells=c('40%','15%','15%','15%','15%'),
    big.mark=",",
    emphasize.strong.rows=which(mode.da.dnc.dest$Mode=='Total',arr.ind=TRUE)
)
```

\newpage

```{r dist.dnc.dest,echo=FALSE,results='asis'}
dist.dnc.dest <- dist.dnc.dest %>%
  arrange(ifelse(Mode=="Total",1,0),desc(as.numeric(TDis_W))) %>%
  transmute('Mode'=Mode,
            'Trip&nbsp;Dist UW'=format(round(as.numeric(TDis_UW),0),big.mark=','),
            'Trip&nbsp;Dist W'=format(round(as.numeric(TDis_W),0),big.mark=','),
            'Percent UW'=format(round(as.numeric(Per_UW),2),big.mark=','),
            'Percent W'=format(round(as.numeric(Per_W),2),big.mark=','),
            'Avg Dist UW'=format(round(as.numeric(avg_uw),2),big.mark=','),
            'Avg Dist W'=format(round(as.numeric(avg_w),2),big.mark=',')
            )
pandoc.table(
    dist.dnc.dest,
    caption="Trip distance (mi) by mode for trips ending in Del Norte County",
    justify=c('left','right','right','right','right','right','right'),
    split.tables=120,
    split.cells=c('20%','15%','25%','10%','10%','10%','10%'),
    big.mark=",",
    emphasize.strong.rows=which(dist.dnc.dest$Mode=='Total',arr.ind=TRUE)
)
```

\newpage

```{r dur.dnc.dest,echo=FALSE,results='asis'}
dur.dnc.dest <- dur.dnc.dest %>%
  arrange(ifelse(Mode=="Total",1,0),desc(as.numeric(TDu_W))) %>%
  transmute(Mode=Mode,
            'Trip&nbsp;Dur UW'=format(round(as.numeric(TDu_UW),0),big.mark=','),
            'Trip&nbsp;Dur W'=format(round(as.numeric(TDu_W),0),big.mark=','),
            'Percent UW'=format(round(as.numeric(Per_UW),2),big.mark=','),
            'Percent W'=format(round(as.numeric(Per_W),2),big.mark=','),
            'Avg Dur UW'=format(round(as.numeric(avg_uw),2),big.mark=','),
            'Avg Dur W'=format(round(as.numeric(avg_w),2),big.mark=',')
            )
pandoc.table(
    dur.dnc.dest,
    caption="Trip duration (min) by mode for trips ending in Del Norte County",
    justify=c('left','right','right','right','right','right','right'),
    split.tables=120,
    split.cells=c('20%','15%','25%','10%','10%','10%','10%'),
    big.mark=",",
    emphasize.strong.rows=which(dur.dnc.dest$Mode=='Total',arr.ind=TRUE)
)
```

\newpage

```{r apurp.dnc.dest,echo=FALSE,results='asis'}
apurp.dnc.dest <- apurp.dnc.dest %>%
  arrange(ifelse(Actpur=="Total",1,0),desc(as.numeric(Ob_W))) %>%
  transmute('Activity Purpose'=Actpur,
            'Obs UW'=format(round(as.numeric(Ob_UW),0),big.mark=','),
            'Obs W'=format(round(as.numeric(Ob_W),0),big.mark=','),
            'Pct UW'=format(round(as.numeric(Per_UW),2),big.mark=','),
            'Pct W'=format(round(as.numeric(Per_W),2),big.mark=',')
            )
pandoc.table(
  apurp.dnc.dest,
  caption="Total number of work trips (APURP=9) for trips ending in Del Norte County",
  justify=c('left','right','right','right','right'),
  split.tables=120,
  split.cells=c('60%','10%','10%','10%','10%'),
  big.mark=",",
  emphasize.strong.rows=which(apurp.dnc.dest$'Activity Purpose'=='Total',arr.ind=TRUE)
)
```

```{r dnc.mode.wact.dest,echo=FALSE,results='asis'}
dnc.mode.wact.dest <- dnc.mode.wact.dest %>%
  arrange(ifelse(Mode=="Total",1,0),desc(as.numeric(Ob_W))) %>%
  transmute(Mode=Mode,
            'Obs UW'=format(round(as.numeric(Ob_UW),0),big.mark=','),
            'Obs W'=format(round(as.numeric(Ob_W),0),big.mark=','),
            'Pct UW'=format(round(as.numeric(Per_UW),2),big.mark=','),
            'Pct W'=format(round(as.numeric(Per_W),2),big.mark=',')
            )
pandoc.table(
  dnc.mode.wact.dest,
  caption="Total number of trips by activity purpose for trips ending in Del Norte County",
  justify=c('left','right','right','right','right'),
  split.tables=120,
  split.cells=c('60%','10%','10%','10%','10%'),
  big.mark=",",
  emphasize.strong.rows=which(dnc.mode.wact.dest$Mode=='Total',arr.ind=TRUE)
)
```

