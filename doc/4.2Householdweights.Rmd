---
title: "4.2 County Level Household Weights"
author: "Suman Mitra"
date: "September 2, 2015"
output: html_document
---

## Overview 

This document explains how county-level weights are developed using the R statistical software for household who participated in the 2012 CHTS. The purpose of these weights is to scale up information provided by respondents to the population of each county based on the socio-economic variables listed below. The household level weights were developed at the county level. Users of these weights are cautioned that these weights should not be applied to lower-level geographies such as cities or zip codes. Similar weights can be developed for these geographies if they contain enough CHTS respondents.

## Methodology

Household-level county weights are calculated by raking at the household level. These weights adjust the relative importance of responses to reflect the different probabilities of selection of respondents, and align sample distributions to population distributions based on the 2010 Census. In particular, household weights were adjusted so that the sums of adjusted weights are equal to known population totals for certain subgroups of the population of each county.  Following NuStats' work for Caltrans, variables used for raking at the household level are:

  * Household size (1, 2, 3, 4 or more) - County wide distribution;
  * Household income (Less than $24,999, $25,000 - $49,999, $50,000 - $74,999, $75,000-$99,999, $100,000-$149,999, $150,000 or above) - County wide            distribution;
  * Total number of workers in the household (0, 1, 2, 3 or more) - County wide distribution; and
  * Total number of vehicles in the household (0, 1, 2, 3 or more) - County wide distribution.

After the raking procedure, very large weights are capped to be no more than five times the mean of weights. To check whether the new weights represent the total population of the counties, we perform some random checks for different variables and the results show that the new weights align with the population of the different counties. 


## R Code and Implementation

The following commands are used to generate county wide household weight.


### Generate Household level weight

First we need to import the person data file and corresponding lookup file (containing location information) and then we merge them.

```{r hw-1,echo=FALSE}
if ( !exists("rd") ) { rd <- "/home/crindt/chts-book" }
p <- function(ps) { return(paste(rd,ps,sep="/")) }
```


```{r hw-2,cache=TRUE}
# Set the working directory

setwd(p("Weight/HHWeight_County"))
#Import the household level variables csv file and give a new name
library(chts2011)
library(chts2011pvt)
#hhdata <- read.csv(p("c:/Users/user/Documents/Suman_research/Caltrans Project/Data/deliv_hh.csv", header=TRUE)
hhdata <- chts_hh
#Import the lookup variable csv file and give a new name (containing zipcode information)
#lookup_hh <- read.csv("c:/Users/user/Documents/Suman_research/Caltrans Project/Data/lookup_hh.csv", header=TRUE)
lookup_hh <- chts_lu_hh
#Merging two data set and giving a new name
hhdata2<-merge(hhdata,lookup_hh, by ="SAMPN", all = TRUE)
# Subset the dataset (excluding the duplicate variables)
nhhdata<-subset(hhdata2,select=-c(HCITY.x,HZIP.x,HXCORD.x,HYCORD.x,HPrimaryCity.x))
# Rename the new added variables
names(nhhdata)[c(76,77,78,79,83)]<-c("HCITY","HZIP","HXCORD","HYCORD","HPrimaryCity")
names(nhhdata)
```

Next, we standardize the HCTFIP value to be an integer.
```{r hw-3}
nhhdata$HCTFIP <- as.integer(nhhdata$HCTFIP) %% 1000
```

Now we have new merged file which is used to generate new household weight. We need to recode the raking variables to make them similar to the census data (Here we are using American Community Survey, 2010 five year estimate data). 

First we will assign zero for 'NA' observations of raking variables because the code we will use later for raking can't read 'NA'. 

```{r hw-4,cache=TRUE}
# Assign 0 for all NA observations
nhhdata[is.na(nhhdata$INCOM)] <- 0
nhhdata[is.na(nhhdata$HHSIZ)] <- 0
nhhdata[is.na(nhhdata$HHVEH)] <- 0
nhhdata[is.na(nhhdata$HHEMP)] <- 0
```

Then, we change the value of household income (INCOM) variable to make it similar to census data. 

```{r hw-5,cache=TRUE}
# Recoding income variable (INCOM)
nhhdata$INCOME<-ifelse(nhhdata$INCOM<=2,1,ifelse((nhhdata$INCOM>=3 &nhhdata$INCOM<=4),2,ifelse(nhhdata$INCOM==5,3,ifelse(nhhdata$INCOM==6,4,ifelse(nhhdata$INCOM==7,5,6)))))
# Show the values
head(nhhdata$INCOME)
```

Next, we recode Household size (HHSIZE) variable.

```{r hw-6,cache=TRUE}
# Recoding household size
nhhdata$HHSIZE<-ifelse(nhhdata$HHSIZ>=4,4,nhhdata$HHSIZ)
# Show values
head(nhhdata$HHSIZE,10)
```

Here, we recode nubmer of household vehicles (HHVEH) variable.

```{r hw-7,cache=TRUE}
# Recoding household vehicle(HHVEH)
nhhdata$HHVEHC<-ifelse(nhhdata$HHVEH>=3,3,nhhdata$HHVEH)
# Show values
head(nhhdata$HHVEHC,10)
```

Finally, we change the value of number of household workers (HHEMP)

```{r hw-8,cache=TRUE}
# Recoding number of workers (HHEMP)
nhhdata$HHWRK<-ifelse(nhhdata$HHEMP>=3,3,nhhdata$HHEMP)
# See the data
head(nhhdata$HHWRK,10)
# Show the names
names(nhhdata)
```

Now we have data file (nhhdata) which has similar coding  as census data for raking variables. 
We need county wide total household data which we collect from census and save it as csv (we organize them as per our requriment).Here we import that file and merge this data with nhhdata. 


```{r hw-9,cache=TRUE}
# Assgin county wide total household into nhhdata file
#Import the county wide total hosuehold csv file and give a new name
tot.hh <- read.csv(p("Weight/Data_County/Total/county_tothh2.csv"), header=TRUE)
# Merging two data set
hhdata3<-merge(nhhdata,tot.hh, by ="HCTFIP", all = TRUE)
names(hhdata3)
head(hhdata3$fpc)
```

So, now we have a new file named hhdata3 which contains all the raking variables informaiton and county wide total household. This is a single file for all counties. 
But we need seperate dataframes for each county. So we need to create a list of seperate dataframes for each county containing all the information.


```{r hw-10,cache=TRUE}
# create list of dataframes for different counties 
hhcnty_list <- split(hhdata3, as.factor(hhdata3$HCTFIP))
# Show the list of one county
head(hhcnty_list[[2]])
```

We need census data of raking variables (Household size, Household income, Number of household vehicles and Number of household workers). We collect this information from census and organize them as per our requriment and save as csv file. Then we import them and create seperate dataframes for each county (the csv file contain informaiton of all the counties).

First, we do it for Household size variable.

```{r hw-11,cache=TRUE}
# Household size data
hhsize.county <- read.csv(p("Weight/Data_County/County_HH/HHSize/hhsize.csv"), header=TRUE)
head(hhsize.county)
# Generate a list of seperate datafrmaes containing household size variable for each county
hhsize.county$id <- 1:nrow(hhsize.county)
hhsize.data <- lapply(split(hhsize.county, hhsize.county$id), function(x){data.frame(HHSIZE = c(1:4),  Freq  = c(x$HS1, x$HS2,x$HS3,x$HS4))                                                      
}
)
# Show
head(hhsize.data[1])
```

Here, we import the Household income variable.

```{r hw-12,cache=TRUE}
# Income
hhincome.county <- read.csv(p("Weight/Data_County/County_HH/Income/hhincome.csv"), header=TRUE)
head(hhincome.county)
hhincome.county$id <- 1:nrow(hhincome.county)
hhincome.data <- lapply(split(hhincome.county, hhincome.county$id), function(x){data.frame(INCOME = c(1:6),  Freq  = c(x$INC1, x$INC2,x$INC3,x$INC4,x$INC5,x$INC6))                                                             
}
)
head(hhincome.data[1])
```

Then, we repeat the process for number of household vehicles variable.

```{r hw-13,cache=TRUE}
## Number of vehicles data
hhveh.county <- read.csv(p("Weight/Data_County/County_HH/HHVeh/hhvehicle.csv"), header=TRUE)
head(hhveh.county)
hhveh.county$id <- 1:nrow(hhveh.county)
hhveh.data <- lapply(split(hhveh.county, hhveh.county$id), function(x){data.frame(HHVEHC = c(0:3),  Freq  = c(x$Veh0, x$Veh1,x$Veh2,x$Veh3))                                                             
}
)
head(hhveh.data[2])
```

Finally, we import nubmer of household number of workers.

```{r hw-14,cache=TRUE}
## Number of workers
hhwrk.county <- read.csv(p("Weight/Data_County/County_HH/Worker/hhworkers.csv"), header=TRUE)
head(hhwrk.county)
hhwrk.county$id <- 1:nrow(hhwrk.county)
hhwrk.data <- lapply(split(hhwrk.county, hhwrk.county$id), function(x){data.frame(HHWRK = c(0:3),  Freq  = c(x$W0, x$W1,x$W2,x$W3))                                                             
}
)
head(hhwrk.data[3])
```

Here we want to set the directory where we want to save our output.

```{r hw-15,cache=TRUE}
# Set directory where we want to save
setwd(p("Weight/HHWeight_County"))
```


As our data is ready for raking, we proceed for raking next. We  do it in a for loop function which generate weight for each county. To do this we need to install the library "survey". First we design a survey using 'svydesign' command and we use sampling without replacement (pps ="brewer") option. The option 'fpc (finite population correction)' is the ratio of sample household number and county wide total household. Then we perform the raking. After raking, we trim the weight so that very large weights were capped to be no more than five times the mean of weight.The following codes also give us informaiotn about the errors (the fip code of counties for which the weight can't be generated). The generated expanded household weights for different counties are saved in our specified directory. 


```{r hw-16,cache=TRUE}
# Raking to create new expanded weight for all counties
#Need library "survey"
library (survey)
# Loop function
for (i in 1:length(hhwrk.data)){ #length must be equal to 58=total number of county
  tryCatch({ ##If there is any error it will give error message but still continue the loop 
  f=seq(6001, 6115, by=2)
  s<-as.character(f[i])
  name=c('HHweight_',s, '.CSV')
  name=paste(name,collapse="")
  temp1<- svydesign(id=~1, weights=~HHWGT,data=hhcnty_list[[i]],fpc=~fpc,pps="brewer") # Survey design (Need library "survey")
  # Raking
  temp3<- rake(temp1, list(~HHSIZE,~INCOME,~HHVEHC,~HHWRK), list(hhsize.data[[i]],hhincome.data[[i]],hhveh.data[[i]],hhwrk.data[[i]]),control = list(maxit = 1000)) 
  # Trim the weights (max value no greater than 5 times the mean)
  temp4<-trimWeights(temp3,lower=(min(weights(temp3))),upper=(5*mean(weights(temp3))))
  # Combine weight with sample no and hh no
  temp5<-cbind(temp4$variables[1:2],weights(temp4))
  colnames(temp5)[3] <- "NEXPHHWGT" # change the column name of weight variable
  write.table(temp5, file =name,sep=",", row.names=FALSE, col.names=TRUE) # Save as csv file
  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n",finally=print(name))}) # Show the errors and the file names
}
```

After running the codes, we get two errors for two county data sets (HCTFIP=3,43) and we need to treat them indiviudally. The errors show that some HHVEHC (number of household vehicles)  categories are absent from sample of these counties, so we don't include HHVEHC as raking variable for these counties in the following codes.

```{r hw-17,cache=TRUE}
# Loop function for the rest of the counties
e=c(2,22) # only for counties which gave error for previous cases (HCTFIP=3[i=2],HCTFIP= 43[i=22])
for (i in e){ 
  tryCatch({
    f=seq(6001, 6115, by=2)
    s<-as.character(f[i])
    name=c('HHweight_',s, '.CSV')
    name=paste(name,collapse="")
    temp1<- svydesign(id=~1, weights=~EXPHHWGT,data=hhcnty_list[[i]], fpc=~fpc,pps="brewer") # Survey design (Need library "survey")
    temp3<- rake(temp1, list(~HHSIZE,~INCOME,~HHWRK), list(hhsize.data[[i]],hhincome.data[[i]],hhwrk.data[[i]]),control = list(maxit = 1000)) # Raking
    temp4<-trimWeights(temp3,lower=(min(weights(temp3))),upper=(5*mean(weights(temp3))))# Trim the weights (max value no greater than 5 times the mean)
    temp5<-cbind(temp4$variables[1:2],weights(temp4))# Combine weight with sample no and hh no
    colnames(temp5)[3] <- "NEXPHHWGT" # change the column name of weight variable
    write.table(temp5, file =name,sep=",", row.names=FALSE, col.names=TRUE) # Save as csv file 
  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n",finally=print(name))}) # Show the errors and the file names
}

```

There is no error now. So, we have expanded household weights for all 58 counties and these weights are saved in the directory we specified earlier. We need to combine these weights of 58 counties into one file. The following codes are used to import and combine them.


```{r hw-18,cache=TRUE}
# Import multiple csv file of new weight and combine into one file
setwd(p("Weight/HHWeight_County"))
# Import the files
filenames <- list.files(path = p("Weight/HHWeight_County"))
# combined the files into one
nhhweight<-do.call("rbind", lapply(filenames, read.csv, header = TRUE)) 
head(nhhweight)
```

Now we have on file which contains new county wide expanded household weight for all counties. We want to generate new county wide household weight (not expanded) from our expanded weight. We know that household weight = Expanded household weight * fpc (finite population correction) and fpc = sample household/county total household. 

First, we merge the fpc data with expanded new household weight.

```{r hw-19,cache=TRUE}
# fpc =sample household number/county total household number
# Subset the fpc
fpc2<-subset(hhdata3,select=c(SAMPN,fpc))
head(fpc2)
# Merge fpc with expanded weight
nhhweight<-merge(fpc2,nhhweight, by ="SAMPN", all = TRUE)
names(nhhweight)
```

Here, we generate the unexpanded new household weight.

```{r hw-20,cache=TRUE}
# Unexpanded household weight= Expanded weight* fpc
nhhweight$NHHWGT<-nhhweight$NEXPHHWGT*nhhweight$fpc
head(nhhweight)
```

Now, we subset the weight data and exclude the fpc variable (since we don't need it).

```{r hw-21,cache=TRUE}
# Subset the dataset (excluding the fpc variable)
nhhweight2<-subset(nhhweight,select=-c(2))
head(nhhweight2)

# Reorder the variables
nhhweight2 <- nhhweight2[,c(1,4,3,2)]
head(nhhweight2)
```

Now we have a file with new county wide expaned and unexpanded household weights. Here we save it in our desired directory.

```{r hw-22,cache=TRUE}
# Save 
setwd(p("Weight/NewWeightData"))
write.csv(nhhweight2, file="nhhweight922015.csv",row.names = FALSE) # save as csv
```

We want to merge the new weight with household data file and save it as csv.

```{r hw-23,cache=TRUE}
# Merge the new weight file with original household data file
nhhdataw<-merge(hhdata,nhhweight2, by =c("SAMPN"), all = TRUE)
head(nhhdataw)
# Save as csv
write.csv(nhhdataw, file="nhhdataw922015.csv",row.names=FALSE)
```

Now we have a household data file with new county wide household weight. 
As we mentioned earlier we want check whether the new weights represent the total household of the counties. So we perform some random checks for different variables using following codes. We do it for Alameda county as an example.

```{r hw-24,cache=TRUE}
# Random Check
setwd(p("Weight/Check"))
# We do it for Alameda county (FIP code=1)
hhdata_01<-subset(nhhdataw,HCTFIP==1)
head(hhdata_01$HCTFIP)

# For household size
hsize<-as.data.frame(table(hhdata_01$HHSIZ))
hsize$Percent<-hsize$Freq*100/sum(hsize$Freq)
hsize
whsize<-aggregate(NEXPHHWGT~HHSIZ,FUN=sum,data=hhdata_01)
whsize$Percent<-whsize$NEXPHHWGT*100/sum(whsize$NEXPHHWGT)
whsize<- rbind(whsize, c("Total", colSums(whsize[,2:3],na.rm = TRUE)))
whsize
```

Then we do a random check for household home ownership (OWN) variable. 

```{r hw-25,cache=TRUE}
# For home ownership  variable
hown<-as.data.frame(table(hhdata_01$OWN))
hown$Percent<-hown$Freq*100/sum(hown$Freq)
hown
wown<-aggregate(NEXPHHWGT~OWN,FUN=sum,data=hhdata_01)
wown$Percent<-wown$NEXPHHWGT*100/sum(wown$NEXPHHWGT)
wown<- rbind(wown, c("Total", colSums(wown[,2:3],na.rm = TRUE)))
wown
```

The total household of Alameda county is 53,2026 (based on census). Our random check shows that the new weights align with the total household of Alameda county for both variables. 
